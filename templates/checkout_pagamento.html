{% extends "base.html" %}

{% block title %}Pagamento Seguro - UzzerStore{% endblock %}

{% block head %}
<style>
.payment-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.payment-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 40px;
    padding: 20px;
    background: var(--card);
    border-radius: var(--radius);
}

.step {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-muted);
}

.step.active {
    color: var(--primary);
    font-weight: 600;
}

.step.completed {
    color: var(--success);
    font-weight: 600;
}

.payment-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
}

.payment-methods {
    background: var(--card);
    padding: 30px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.payment-options {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.payment-option {
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.payment-option:hover {
    border-color: var(--primary);
}

.payment-option.selected {
    border-color: var(--primary);
    background: rgba(124,58,237,0.05);
}

.payment-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.payment-title {
    font-weight: 600;
    font-size: 1.1rem;
}

.payment-description {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.payment-form {
    display: none;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}

.payment-form.active {
    display: block;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.pix-section {
    text-align: center;
    padding: 20px;
}

.pix-qr {
    width: 200px;
    height: 200px;
    background: var(--bg);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px auto;
    font-size: 3rem;
}

.pix-code {
    background: var(--bg);
    padding: 16px;
    border-radius: var(--radius);
    font-family: monospace;
    word-break: break-all;
    margin: 16px 0;
    border: 1px solid var(--border);
}

.security-info {
    background: rgba(16,185,129,0.1);
    border: 1px solid var(--success);
    border-radius: var(--radius);
    padding: 16px;
    margin: 20px 0;
}

.security-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--success);
    margin-bottom: 8px;
}

.pay-button {
    width: 100%;
    background: var(--primary);
    color: white;
    border: none;
    padding: 16px;
    border-radius: var(--radius);
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 20px;
}

.pay-button:hover {
    background: #6d28d9;
    transform: translateY(-2px);
}

.pay-button:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    transform: none;
}

.order-summary {
    background: var(--card);
    padding: 30px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    height: fit-content;
    position: sticky;
    top: 20px;
}

@media (max-width: 768px) {
    .payment-content {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .payment-steps {
        flex-direction: column;
        gap: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="payment-steps">
        <div class="step completed">
            <span>1Ô∏è‚É£</span>
            <span>Dados de Entrega</span>
        </div>
        <div class="step active">
            <span>2Ô∏è‚É£</span>
            <span>Pagamento</span>
        </div>
        <div class="step">
            <span>3Ô∏è‚É£</span>
            <span>Confirma√ß√£o</span>
        </div>
    </div>
    
    <div class="payment-content">
        <div class="payment-methods">
            <h2>üí≥ Escolha a forma de pagamento</h2>
            
            <div class="security-info">
                <div class="security-title">
                    üîí <span>Pagamento 100% Seguro</span>
                </div>
                <p>Seus dados s√£o protegidos com criptografia SSL e n√£o s√£o armazenados em nossos servidores.</p>
            </div>
            
            <div class="payment-options">
                <!-- PIX -->
                <div class="payment-option" onclick="selectPayment('pix')">
                    <div class="payment-header">
                        <span style="font-size: 2rem;">üì±</span>
                        <div>
                            <div class="payment-title">PIX</div>
                            <div class="payment-description">Aprova√ß√£o instant√¢nea ‚Ä¢ Sem taxas</div>
                        </div>
                    </div>
                    
                    <div class="payment-form" id="pix-form">
                        <div class="pix-section">
                            <h4>üì≤ Pague com PIX</h4>
                            <p>Transfira para a conta da {{ conta_recebimento.nome_titular }}</p>
                            
                            <!-- Informa√ß√µes da conta -->
                            <div style="background: var(--bg); padding: 16px; border-radius: var(--radius); margin: 16px 0; text-align: left;">
                                <h5 style="margin-bottom: 12px; color: var(--primary);">üí≥ Dados para Transfer√™ncia</h5>
                                <div style="font-size: 0.9rem; line-height: 1.6;">
                                    <strong>Favorecido:</strong> {{ conta_recebimento.nome_titular }}<br>
                                    <strong>{{ conta_recebimento.banco }}</strong><br>
                                    <strong>Ag√™ncia:</strong> {{ conta_recebimento.agencia }} | 
                                    <strong>Conta:</strong> {{ conta_recebimento.conta }}<br>
                                    <strong>{{ 'CPF' if conta_recebimento.cpf_cnpj|length <= 14 else 'CNPJ' }}:</strong> {{ conta_recebimento.cpf_cnpj }}
                                </div>
                            </div>
                            
                            {% if conta_recebimento.chave_pix %}
                            <div class="pix-qr">
                                üì±
                            </div>
                            
                            <div class="pix-code" id="pixCode">
                                {{ codigo_pix }}
                            </div>
                            
                            <button type="button" onclick="copyPix()" class="btn btn-secondary">
                                üìã Copiar C√≥digo PIX
                            </button>
                            
                            <div style="background: var(--bg); padding: 12px; border-radius: var(--radius); margin-top: 12px; font-size: 0.9rem;">
                                <strong>Chave PIX ({{ conta_recebimento.tipo_chave_pix }}):</strong><br>
                                <code style="background: white; padding: 4px 8px; border-radius: 4px;">{{ conta_recebimento.chave_pix }}</code>
                            </div>
                            {% endif %}
                            
                            <p style="margin-top: 16px; color: var(--text-muted); font-size: 0.9rem;">
                                Ap√≥s o pagamento, clique em "Confirmar Pagamento"
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Cart√£o de Cr√©dito -->
                <div class="payment-option" onclick="selectPayment('cartao')">
                    <div class="payment-header">
                        <span style="font-size: 2rem;">üí≥</span>
                        <div>
                            <div class="payment-title">Cart√£o de Cr√©dito</div>
                            <div class="payment-description">Parcelamento em at√© 12x ‚Ä¢ Todas as bandeiras</div>
                        </div>
                    </div>
                    
                    <div class="payment-form" id="cartao-form">
                        <div class="form-group">
                            <label for="numero_cartao">N√∫mero do Cart√£o</label>
                            <input type="text" id="numero_cartao" name="numero_cartao" 
                                   placeholder="0000 0000 0000 0000" maxlength="19">
                        </div>
                        
                        <div class="form-group">
                            <label for="nome_cartao">Nome no Cart√£o</label>
                            <input type="text" id="nome_cartao" name="nome_cartao" 
                                   placeholder="Nome como est√° no cart√£o">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="validade">Validade</label>
                                <input type="text" id="validade" name="validade" 
                                       placeholder="MM/AA" maxlength="5">
                            </div>
                            
                            <div class="form-group">
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" name="cvv" 
                                       placeholder="000" maxlength="3">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="parcelas">Parcelamento</label>
                            <select id="parcelas" name="parcelas">
                                <option value="1">1x de {{ pedido.total|currency }} sem juros</option>
                                <option value="2">2x de {{ (pedido.total/2)|currency }} sem juros</option>
                                <option value="3">3x de {{ (pedido.total/3)|currency }} sem juros</option>
                                <option value="6">6x de {{ (pedido.total/6)|currency }} sem juros</option>
                                <option value="12">12x de {{ (pedido.total/12)|currency }} sem juros</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" id="payButton" class="pay-button" onclick="processPayment()" disabled>
                üîí Finalizar Pagamento
            </button>
        </div>
        
        <div class="order-summary">
            <h3>üìã Resumo do Pedido</h3>
            <p><strong>Pedido #{{ pedido.id }}</strong></p>
            
            <div style="margin: 20px 0; padding: 20px; background: var(--bg); border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span>Subtotal:</span>
                    <span>{{ pedido.total|currency }}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span>Frete:</span>
                    <span style="color: var(--success);">Gr√°tis</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.1rem; padding-top: 12px; border-top: 1px solid var(--border);">
                    <span>Total:</span>
                    <span style="color: var(--primary);">{{ pedido.total|currency }}</span>
                </div>
            </div>
            
            <div style="font-size: 0.8rem; color: var(--text-muted); text-align: center;">
                üîí Seus dados est√£o seguros<br>
                Certificado SSL v√°lido
            </div>
        </div>
    </div>
</div>

<script>
let selectedPayment = null;

function selectPayment(method) {
    // Remover sele√ß√£o anterior
    document.querySelectorAll('.payment-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.querySelectorAll('.payment-form').forEach(form => {
        form.classList.remove('active');
    });
    
    // Selecionar novo m√©todo
    event.currentTarget.classList.add('selected');
    document.getElementById(method + '-form').classList.add('active');
    
    selectedPayment = method;
    document.getElementById('payButton').disabled = false;
    
    // Atualizar texto do bot√£o
    const payButton = document.getElementById('payButton');
    if (method === 'pix') {
        payButton.innerHTML = 'üì± Confirmar Pagamento PIX';
    } else {
        payButton.innerHTML = 'üí≥ Pagar com Cart√£o';
    }
}

function copyPix() {
    const pixCode = document.getElementById('pixCode').textContent;
    navigator.clipboard.writeText(pixCode).then(() => {
        alert('‚úÖ C√≥digo PIX copiado!');
    });
}

// M√°scaras para cart√£o
document.getElementById('numero_cartao').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
    e.target.value = value;
});

document.getElementById('validade').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.replace(/(\d{2})(\d)/, '$1/$2');
    }
    e.target.value = value;
});

document.getElementById('cvv').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

function processPayment() {
    if (!selectedPayment) {
        alert('‚ö†Ô∏è Selecione uma forma de pagamento');
        return;
    }
    
    const payButton = document.getElementById('payButton');
    payButton.disabled = true;
    payButton.innerHTML = '‚è≥ Processando...';
    
    const formData = new FormData();
    formData.append('pedido_id', '{{ pedido.id }}');
    formData.append('forma_pagamento', selectedPayment);
    
    if (selectedPayment === 'cartao') {
        formData.append('numero_cartao', document.getElementById('numero_cartao').value);
        formData.append('nome_cartao', document.getElementById('nome_cartao').value);
        formData.append('validade', document.getElementById('validade').value);
        formData.append('cvv', document.getElementById('cvv').value);
    }
    
    fetch('{{ url_for("processar_pagamento") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert('‚ùå ' + data.message);
            payButton.disabled = false;
            payButton.innerHTML = selectedPayment === 'pix' ? 'üì± Confirmar Pagamento PIX' : 'üí≥ Pagar com Cart√£o';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('‚ùå Erro no processamento. Tente novamente.');
        payButton.disabled = false;
        payButton.innerHTML = selectedPayment === 'pix' ? 'üì± Confirmar Pagamento PIX' : 'üí≥ Pagar com Cart√£o';
    });
}
</script>
{% endblock %}