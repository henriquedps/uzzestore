{% extends "base_mobile.html" %}
{% block title %}UzzeStore Mobile - Moda com Estilo{% endblock %}

{% block content %}
<!-- Hero Section Mobile -->
<section class="hero-mobile">
    <h1 class="hero-title">Busque sua inspiração</h1>
    <p class="hero-subtitle">Descubra as últimas tendências em moda</p>
</section>

<!-- Categories Section -->
<section class="categories-mobile" style="margin-bottom: var(--spacing-lg);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
        <h2 style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary);">Categorias</h2>
        <a href="#" style="color: var(--accent-color); font-size: 0.9rem; text-decoration: none;">Ver todas</a>
    </div>
    
    <div style="display: flex; gap: var(--spacing-md); overflow-x: auto; padding-bottom: var(--spacing-sm); -webkit-overflow-scrolling: touch;">
        {% for categoria in categorias %}
        <a href="{{ url_for('mobile_index', categoria=categoria.categoria) }}" 
           class="category-chip"
           style="display: flex; flex-direction: column; align-items: center; min-width: 80px; padding: var(--spacing-md); background: var(--bg-white); border-radius: var(--radius-lg); text-decoration: none; color: var(--text-primary); box-shadow: var(--shadow-sm); transition: var(--transition-fast);">
            <div style="width: 48px; height: 48px; background: var(--secondary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: var(--spacing-sm); font-size: 20px;">
                {% if categoria.categoria == 'Camisas' %}
                    <i class="fas fa-tshirt"></i>
                {% elif categoria.categoria == 'Calças' %}
                    <i class="fas fa-tshirt"></i>
                {% elif categoria.categoria == 'Vestidos' %}
                    <i class="fas fa-female"></i>
                {% elif categoria.categoria == 'Calçados' %}
                    <i class="fas fa-shoe-prints"></i>
                {% elif categoria.categoria == 'Acessórios' %}
                    <i class="fas fa-gem"></i>
                {% else %}
                    <i class="fas fa-tag"></i>
                {% endif %}
            </div>
            <span style="font-size: 0.8rem; font-weight: 500; text-align: center;">{{ categoria.categoria }}</span>
        </a>
        {% endfor %}
    </div>
</section>

<!-- Products Section -->
<section class="products-section-mobile">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
        <h2 style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary);">
            {% if categoria_selecionada %}
                {{ categoria_selecionada }}
            {% else %}
                Produtos em Destaque
            {% endif %}
        </h2>
        <span style="color: var(--text-secondary); font-size: 0.9rem;">{{ produtos|length }} item{{ 's' if produtos|length != 1 else '' }}</span>
    </div>

    {% if produtos %}
        <div class="products-grid-mobile">
            {% for produto in produtos %}
                <div class="product-card-mobile"
                     data-preco="{{ ('%.2f'|format(produto.preco|float)) }}"
                     data-categoria="{{ produto.categoria or '' }}"
                     data-nome="{{ produto.nome|e }}"
                     data-id="{{ produto.id }}">
                    
                    <div class="product-image-mobile">
                        <a href="{{ url_for('produto_detalhes', produto_id=produto.id) }}">
                            <img src="{{ produto.imagem or '' }}"
                                 alt="{{ produto.nome }}"
                                 loading="lazy"
                                 onerror="imgFallbackMobile(this, 400, 400, 'Sem Imagem')"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        </a>
                        
                        <!-- Quick actions overlay -->
                        <div style="position: absolute; top: var(--spacing-sm); right: var(--spacing-sm); display: flex; flex-direction: column; gap: var(--spacing-xs);">
                            <button class="quick-action-btn" data-product-id="{{ produto.id }}" data-action="favorite" aria-label="Favoritar">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="product-info-mobile">
                        <h3 class="product-name-mobile">
                            <a href="{{ url_for('produto_detalhes', produto_id=produto.id) }}" style="text-decoration: none; color: inherit;">{{ produto.nome }}</a>
                        </h3>
                        {% if produto.categoria %}
                            <span style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">{{ produto.categoria }}</span>
                        {% endif %}
                        <div class="product-price-mobile">{{ produto.preco|currency }}</div>
                        
                        <button class="btn-add-cart-mobile" onclick="adicionarAoCarrinhoMobile({{ produto.id }})" data-product-id="{{ produto.id }}" data-product-name="{{ produto.nome|e }}">
                            <i class="fas fa-shopping-bag"></i>
                            <span>Adicionar</span>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Load More Button -->
        <div style="text-align: center; margin-top: var(--spacing-xl);">
            <button class="load-more-btn" onclick="loadMoreProducts()" style="background: var(--bg-white); border: 1px solid var(--border-light); padding: var(--spacing-md) var(--spacing-xl); border-radius: var(--radius-full); color: var(--text-primary); font-weight: 500; cursor: pointer; transition: var(--transition-fast);">
                <i class="fas fa-plus" style="margin-right: var(--spacing-sm);"></i>
                Carregar mais produtos
            </button>
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h3>Nenhum produto encontrado</h3>
            <p>Em breve novos produtos incríveis!</p>
        </div>
    {% endif %}
</section>

<!-- Floating Action Button for Filters -->
<button class="fab" onclick="openFilters()" aria-label="Filtros">
    <i class="fas fa-filter"></i>
</button>

<!-- Filters Bottom Sheet -->
<div class="filters-bottom-sheet" id="filtersBottomSheet">
    <div class="bottom-sheet-overlay" onclick="closeFilters()"></div>
    <div class="bottom-sheet-content">
        <div class="bottom-sheet-header">
            <h3>Filtros</h3>
            <button onclick="closeFilters()" class="close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="filters-content-mobile">
            <!-- Sort Options -->
            <div class="filter-section">
                <h4>Ordenar por</h4>
                <div class="sort-options">
                    <label class="sort-option">
                        <input type="radio" name="sort" value="destaque" checked>
                        <span>Em destaque</span>
                    </label>
                    <label class="sort-option">
                        <input type="radio" name="sort" value="menor-preco">
                        <span>Menor preço</span>
                    </label>
                    <label class="sort-option">
                        <input type="radio" name="sort" value="maior-preco">
                        <span>Maior preço</span>
                    </label>
                    <label class="sort-option">
                        <input type="radio" name="sort" value="nome-az">
                        <span>Nome A-Z</span>
                    </label>
                </div>
            </div>
            
            <!-- Price Range -->
            <div class="filter-section">
                <h4>Faixa de preço</h4>
                <div class="price-range-mobile">
                    <input type="range" id="priceRange" min="0" max="1000" value="500" 
                           style="width: 100%; margin: var(--spacing-md) 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-secondary);">
                        <span>R$ 0</span>
                        <span>R$ <span id="priceValue">500</span></span>
                        <span>R$ 1000+</span>
                    </div>
                </div>
            </div>
            
            <!-- Categories -->
            {% if categorias %}
            <div class="filter-section">
                <h4>Categorias</h4>
                <div class="category-options">
                    {% for categoria in categorias %}
                    <label class="filter-checkbox">
                        <input type="checkbox" value="{{ categoria.categoria }}">
                        <span class="checkmark"></span>
                        <span>{{ categoria.categoria }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="bottom-sheet-actions">
            <button onclick="clearFilters()" class="btn-secondary">Limpar</button>
            <button onclick="applyFilters()" class="btn-primary">Aplicar Filtros</button>
        </div>
    </div>
</div>

<style>
/* Quick action buttons */
.quick-action-btn {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: var(--transition-fast);
    backdrop-filter: blur(10px);
}

.quick-action-btn:hover {
    background: var(--bg-white);
    transform: scale(1.1);
}

.quick-action-btn.active {
    background: var(--error-color);
    color: white;
}

/* Category chips */
.category-chip:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Load more button */
.load-more-btn:hover {
    background: var(--bg-light);
    border-color: var(--primary-color);
}

/* Bottom Sheet for Filters */
.filters-bottom-sheet {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 2000;
    display: none;
}

.filters-bottom-sheet.active {
    display: block;
}

.bottom-sheet-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
}

.bottom-sheet-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-white);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    max-height: 80vh;
    overflow: hidden;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
}

.filters-bottom-sheet.active .bottom-sheet-content {
    transform: translateY(0);
}

.bottom-sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-light);
}

.bottom-sheet-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.close-btn {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    padding: var(--spacing-sm);
    border-radius: 50%;
    color: var(--text-secondary);
    transition: var(--transition-fast);
}

.close-btn:hover {
    background: var(--bg-light);
    color: var(--text-primary);
}

.filters-content-mobile {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-lg);
}

.filter-section {
    margin-bottom: var(--spacing-xl);
}

.filter-section h4 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--text-primary);
}

.sort-options, .category-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.sort-option, .filter-checkbox {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    cursor: pointer;
    padding: var(--spacing-sm) 0;
}

.sort-option input[type="radio"],
.filter-checkbox input[type="checkbox"] {
    display: none;
}

.sort-option span,
.filter-checkbox span:last-child {
    flex: 1;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition-fast);
}

.filter-checkbox input:checked + .checkmark {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.filter-checkbox input:checked + .checkmark::after {
    content: "✓";
    font-size: 12px;
    font-weight: bold;
}

.sort-option::before {
    content: "";
    width: 16px;
    height: 16px;
    border: 2px solid var(--border-primary);
    border-radius: 50%;
    margin-right: var(--spacing-md);
    transition: var(--transition-fast);
}

.sort-option input:checked + span::before {
    background: var(--primary-color);
    border-color: var(--primary-color);
    box-shadow: inset 0 0 0 3px white;
}

.bottom-sheet-actions {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    border-top: 1px solid var(--border-light);
    background: var(--bg-light);
}

.btn-secondary, .btn-primary {
    flex: 1;
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-fast);
    border: none;
    min-height: var(--touch-target);
}

.btn-secondary {
    background: var(--bg-white);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
}

.btn-secondary:hover {
    background: var(--bg-light);
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--accent-color);
}

/* Scrollbar for categories */
.categories-mobile > div:last-child {
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.categories-mobile > div:last-child::-webkit-scrollbar {
    display: none;
}
</style>

<script>
// Price range slider
document.getElementById('priceRange').addEventListener('input', function(e) {
    document.getElementById('priceValue').textContent = e.target.value;
});

// Filter functions
function openFilters() {
    document.getElementById('filtersBottomSheet').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeFilters() {
    document.getElementById('filtersBottomSheet').classList.remove('active');
    document.body.style.overflow = '';
}

function clearFilters() {
    // Reset all form inputs
    document.querySelectorAll('#filtersBottomSheet input').forEach(input => {
        if (input.type === 'radio' && input.value === 'destaque') {
            input.checked = true;
        } else if (input.type === 'checkbox') {
            input.checked = false;
        } else if (input.type === 'range') {
            input.value = 500;
            document.getElementById('priceValue').textContent = '500';
        }
    });
}

function applyFilters() {
    // Collect filter values
    const sort = document.querySelector('input[name="sort"]:checked').value;
    const priceMax = document.getElementById('priceRange').value;
    const selectedCategories = Array.from(document.querySelectorAll('.filter-checkbox input:checked'))
        .map(input => input.value);
    
    // Apply filters to products
    filterProducts(sort, priceMax, selectedCategories);
    closeFilters();
}

function filterProducts(sort, priceMax, categories) {
    const products = document.querySelectorAll('.product-card-mobile');
    let visibleProducts = [];
    
    products.forEach(product => {
        const price = parseFloat(product.dataset.preco);
        const category = product.dataset.categoria;
        
        // Check price filter
        const priceMatch = price <= parseInt(priceMax);
        
        // Check category filter
        const categoryMatch = categories.length === 0 || categories.includes(category);
        
        if (priceMatch && categoryMatch) {
            product.style.display = 'block';
            visibleProducts.push(product);
        } else {
            product.style.display = 'none';
        }
    });
    
    // Sort visible products
    sortProducts(visibleProducts, sort);
    
    // Update product count
    updateProductCount(visibleProducts.length);
}

function sortProducts(products, sortType) {
    const container = document.querySelector('.products-grid-mobile');
    
    products.sort((a, b) => {
        switch (sortType) {
            case 'menor-preco':
                return parseFloat(a.dataset.preco) - parseFloat(b.dataset.preco);
            case 'maior-preco':
                return parseFloat(b.dataset.preco) - parseFloat(a.dataset.preco);
            case 'nome-az':
                return a.dataset.nome.localeCompare(b.dataset.nome);
            case 'nome-za':
                return b.dataset.nome.localeCompare(a.dataset.nome);
            default:
                return 0;
        }
    });
    
    // Reorder DOM elements
    products.forEach(product => container.appendChild(product));
}

function updateProductCount(count) {
    const countElement = document.querySelector('.products-section-mobile span');
    if (countElement) {
        countElement.textContent = `${count} item${count !== 1 ? 's' : ''}`;
    }
}

function toggleFavorite(productId) {
    console.log('Toggle favorite for product:', productId);
    // Add to favorites logic here
}



// Event delegation for product actions
document.addEventListener('click', function(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    const action = target.dataset.action;
    const productId = target.dataset.productId;
    const productName = target.dataset.productName;
    
    switch (action) {
        case 'favorite':
            const icon = target.querySelector('i');
            if (icon.classList.contains('far')) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                target.classList.add('active');
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                target.classList.remove('active');
            }
            toggleFavorite(productId);
            break;
            

            
        case 'addtocart':
            addToCartMobile(productId, productName);
            break;
    }
});

function loadMoreProducts() {
    // Load more products logic here
    console.log('Loading more products...');
}

// Intersection Observer for animations
if ('IntersectionObserver' in window) {
    const animateOnScroll = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    });

    document.querySelectorAll('.product-card-mobile').forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = `opacity 0.5s ease ${index * 0.1}s, transform 0.5s ease ${index * 0.1}s`;
        animateOnScroll.observe(card);
    });
}

// Pull to refresh simulation
let startY = 0;
let currentY = 0;
let isPulling = false;

document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) {
        startY = e.touches[0].clientY;
        isPulling = true;
    }
});

document.addEventListener('touchmove', (e) => {
    if (!isPulling) return;
    
    currentY = e.touches[0].clientY;
    const pullDistance = currentY - startY;
    
    if (pullDistance > 0 && pullDistance < 100) {
        document.body.style.transform = `translateY(${pullDistance * 0.5}px)`;
    }
});

document.addEventListener('touchend', () => {
    if (isPulling) {
        const pullDistance = currentY - startY;
        
        if (pullDistance > 50) {
            // Trigger refresh
            location.reload();
        } else {
            document.body.style.transform = '';
        }
        
        isPulling = false;
    }
});

// Função para adicionar ao carrinho (mobile)
async function adicionarAoCarrinhoMobile(produtoId) {
    try {
        const response = await fetch(`/carrinho/adicionar/${produtoId}?ajax=true`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Abrir a sacola lateral
            if (typeof toggleSacola === 'function') {
                toggleSacola();
            }
            
            // Opcional: mostrar notificação
            showNotification('Produto adicionado ao carrinho!', 'success');
        } else {
            showNotification(data.message || 'Erro ao adicionar produto', 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('Erro ao adicionar produto ao carrinho', 'error');
    }
}

// Função para mostrar notificações
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">&times;</button>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-family: Inter, sans-serif;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.3s ease;
    `;
    
    notification.querySelector('button').style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }
    }, 3000);
}
</script>
{% endblock %}