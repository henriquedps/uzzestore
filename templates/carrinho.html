{% extends "base.html" %}

{% block title %}Carrinho - UzzerStore{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modern-cart.css') }}">
{% endblock %}

{% block content %}
<div class="cart-header">
    <h1>🛒 Minha Sacola</h1>
    <div class="cart-breadcrumb">
        <a href="{{ url_for('index') }}">Início</a> > 
        <a href="{{ url_for('index') }}">Produtos</a> > 
        <span>Carrinho</span>
    </div>
</div>

<div class="carrinho-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if itens %}
        <div class="carrinho-content">
            <div class="itens-carrinho">
                {% for item in itens %}
                    <div class="item-carrinho">
                        <div class="item-imagem-container">
                            {% if item.produto.imagem %}
                                <img src="{{ item.produto.imagem }}" alt="{{ item.produto.nome }}" class="item-imagem">
                            {% else %}
                                <div class="item-sem-imagem">👕</div>
                            {% endif %}
                        </div>

                        <div class="item-info">
                            <h3 class="item-nome">{{ item.produto.nome }}</h3>
                            <p class="item-detalhes">
                                <span class="badge">{{ item.tamanho }}</span>
                                <span class="badge">{{ item.cor }}</span>
                            </p>
                        </div>

                        <div class="item-acoes">
                            <div class="quantidade-controle">
                                <button class="btn-quantidade" onclick="alterarQuantidade({{ item.produto.id }}, '{{ item.tamanho }}', '{{ item.cor }}', -1)">-</button>
                                <span class="quantidade-valor">{{ item.quantidade }}</span>
                                <button class="btn-quantidade" onclick="alterarQuantidade({{ item.produto.id }}, '{{ item.tamanho }}', '{{ item.cor }}', 1)">+</button>
                            </div>
                            <p class="item-preco">R$ {{ "%.2f"|format(item.produto.preco * item.quantidade) }}</p>
                            <button class="btn-remover" onclick="removerItem({{ item.produto.id }}, '{{ item.tamanho }}', '{{ item.cor }}')">Remover</button>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="resumo-carrinho">
                <h2>Resumo do Pedido</h2>
                <div class="resumo-linha">
                    <span>Subtotal</span>
                    <span>{{ total|currency }}</span>
                </div>
                <div class="resumo-total">
                    <span>Total</span>
                    <span>{{ total|currency }}</span>
                </div>
                {% if session.user_id %}
                    <a href="{{ url_for('checkout') }}" class="btn-checkout">Finalizar Compra</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn-checkout">Fazer Login</a>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="carrinho-vazio">
            <h2>Seu carrinho está vazio</h2>
            <a href="{{ url_for('index') }}" class="btn-explorar">Explorar Produtos</a>
        </div>
    {% endif %}
</div>

<script>
function alterarQuantidade(produtoId, tamanho, cor, delta) {
    fetch(/carrinho/alterar-quantidade/, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tamanho, cor, delta })
    }).then(r => r.json()).then(d => d.success ? location.reload() : alert(d.message));
}

function removerItem(produtoId, tamanho, cor) {
    if (confirm('Remover este item?')) {
        fetch(/carrinho/remover/, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tamanho, cor })
        }).then(r => r.json()).then(d => d.success ? location.reload() : alert(d.message));
    }
}
</script>
{% endblock %}
