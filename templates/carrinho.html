{% extends "base.html" %}

{% block title %}Carrinho - UzzerStore{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modern-cart.css') }}">
{% endblock %}

{% block content %}
<!-- Header do Carrinho -->
<div class="cart-header">
    <h1>üõí Minha Sacola</h1>
    <div class="cart-breadcrumb">
        <a href="{{ url_for('index') }}">In√≠cio</a> > 
        <a href="{{ url_for('index') }}">Produtos</a> > 
        <span>Carrinho</span>
    </div>
</div>

<div class="carrinho-container">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if itens %}
        <div class="carrinho-content">
            <div class="itens-carrinho">
                {% for item in itens %}
                    <div class="item-carrinho">
                        <div class="item-imagem-container">
                            {% if item.produto.imagem %}
                                <img src="{{ item.produto.imagem }}" alt="{{ item.produto.nome }}" class="item-imagem"
                                     onerror="imgFallback(this, 120, 120, 'Produto')">
                            {% else %}
                                <div class="item-sem-imagem">üëï</div>
                            {% endif %}
                        </div>
                        
                        <div class="item-info">
                            <h3>{{ item.produto.nome }}</h3>
                            <p class="item-preco">{{ item.produto.preco|currency }}</p>
                            <div class="item-detalhes">
                                <span class="item-tamanho">Tam: P</span>
                                <span class="item-cor">Cor: Marinho</span>
                            </div>
                        </div>
                        
                        <div class="item-quantidade-container">
                            <div class="quantidade-controls">
                                <button class="btn-quantidade" onclick="updateQuantity({{ item.produto.id }}, -1)">‚àí</button>
                                <span class="quantidade-display">{{ item.quantidade }}</span>
                                <button class="btn-quantidade" onclick="updateQuantity({{ item.produto.id }}, 1)">+</button>
                            </div>
                        </div>
                        
                        <div class="item-subtotal">
                            <p class="subtotal-valor">{{ item.subtotal|currency }}</p>
                            <button class="btn-remover" onclick="removeItem({{ item.produto.id }})">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <div class="carrinho-resumo">
                <div class="resumo-card">
                    <h3>üìã Resumo do Pedido</h3>
                    
                    <!-- Cupom de Desconto -->
                    <div class="cupom-section">
                        <h4>üé´ Cupom de Desconto</h4>
                        <div class="cupom-input-group">
                            <input type="text" class="cupom-input" placeholder="Digite seu cupom" id="cupom-input">
                            <button class="btn-cupom" onclick="aplicarCupom()">Aplicar</button>
                        </div>
                    </div>
                    
                    <div class="resumo-linha">
                        <span>Subtotal ({{ itens|length }} {{ 'item' if itens|length == 1 else 'itens' }}):</span>
                        <span>{{ total|currency }}</span>
                    </div>
                    <div class="resumo-linha">
                        <span>Frete:</span>
                        <span class="resumo-frete">GR√ÅTIS</span>
                    </div>
                    <div class="resumo-linha" style="display: none;" id="desconto-linha">
                        <span>Desconto:</span>
                        <span id="desconto-valor">R$ 0,00</span>
                    </div>
                    
                    <div class="resumo-total">
                        <div class="resumo-linha">
                            <span>Total:</span>
                            <span id="total-final">{{ total|currency }}</span>
                        </div>
                    </div>
                    
                    {% if session.user_id %}
                        <a href="{{ url_for('checkout') }}" class="btn-checkout">
                            üí≥ Finalizar Compra
                        </a>
                    {% else %}
                        <div class="login-necessario">
                            <p>Fa√ßa login para finalizar a compra</p>
                            <a href="{{ url_for('login') }}" class="btn-login-checkout">
                                üîê Fazer Login
                            </a>
                            <p style="font-size: 0.9rem; margin-top: 10px; color: #666;">
                                N√£o tem conta? <a href="{{ url_for('cadastro') }}" style="color: #e67e22; text-decoration: none;">Cadastre-se aqui</a>
                            </p>
                        </div>
                    {% endif %}
                    
                    <button class="btn-limpar" onclick="limparCarrinho()">
                        üóëÔ∏è Limpar Carrinho
                    </button>
                </div>
            </div>
        </div>
    {% else %}
        <div class="carrinho-vazio">
            <h2>üòî Sua sacola est√° vazia</h2>
            <p>Que tal adicionar alguns produtos incr√≠veis?</p>
            <a href="{{ url_for('index') }}" class="btn-comprar">üõçÔ∏è Ver Produtos</a>
        </div>
    {% endif %}
</div>

<script>
// Fun√ß√£o para atualizar quantidade
function updateQuantity(produtoId, change) {
    const quantidadeElement = document.querySelector(`[data-produto-id="${produtoId}"] .quantidade-display`);
    if (!quantidadeElement) return;
    
    let quantidade = parseInt(quantidadeElement.textContent) + change;
    if (quantidade < 1) quantidade = 1;
    
    // Aqui voc√™ faria uma requisi√ß√£o AJAX para atualizar no servidor
    // Por enquanto, apenas atualiza visualmente
    quantidadeElement.textContent = quantidade;
    
    // Atualizar subtotal do item
    updateItemSubtotal(produtoId, quantidade);
}

// Fun√ß√£o para remover item
function removeItem(produtoId) {
    if (confirm('Tem certeza que deseja remover este item?')) {
        window.location.href = `/carrinho/remover/${produtoId}`;
    }
}

// Fun√ß√£o para limpar carrinho
function limparCarrinho() {
    if (confirm('Tem certeza que deseja limpar todo o carrinho?')) {
        window.location.href = '{{ url_for("carrinho_limpar") }}';
    }
}

// Fun√ß√£o para aplicar cupom
function aplicarCupom() {
    const cupomInput = document.getElementById('cupom-input');
    const cupom = cupomInput.value.trim().toUpperCase();
    
    if (!cupom) {
        alert('Digite um cupom v√°lido');
        return;
    }
    
    // Simular aplica√ß√£o de cupom
    const cuponsValidos = {
        'DESCONTO10': 0.10,
        'BEMVINDO': 0.15,
        'FRETEGRATIS': 0.05
    };
    
    if (cuponsValidos[cupom]) {
        const desconto = cuponsValidos[cupom];
        const total = parseFloat('{{ total }}'.replace(',', '.'));
        const valorDesconto = total * desconto;
        const novoTotal = total - valorDesconto;
        
        // Mostrar desconto
        document.getElementById('desconto-linha').style.display = 'flex';
        document.getElementById('desconto-valor').textContent = `- R$ ${valorDesconto.toFixed(2).replace('.', ',')}`;
        document.getElementById('total-final').textContent = `R$ ${novoTotal.toFixed(2).replace('.', ',')}`;
        
        // Feedback visual
        cupomInput.style.borderColor = '#27ae60';
        cupomInput.style.backgroundColor = '#d4edda';
        
        alert(`Cupom aplicado! Desconto de ${(desconto * 100)}%`);
    } else {
        // Cupom inv√°lido
        cupomInput.style.borderColor = '#e74c3c';
        cupomInput.style.backgroundColor = '#f8d7da';
        alert('Cupom inv√°lido ou expirado');
        
        // Resetar ap√≥s 3 segundos
        setTimeout(() => {
            cupomInput.style.borderColor = '#e9ecef';
            cupomInput.style.backgroundColor = 'white';
        }, 3000);
    }
}

// Fun√ß√£o para atualizar subtotal do item
function updateItemSubtotal(produtoId, quantidade) {
    // Esta fun√ß√£o seria implementada com a l√≥gica real do seu backend
    console.log(`Atualizando quantidade do produto ${produtoId} para ${quantidade}`);
}

// Anima√ß√µes na entrada da p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Animar entrada dos itens
    const items = document.querySelectorAll('.item-carrinho');
    items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        setTimeout(() => {
            item.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Animar resumo
    const resumo = document.querySelector('.carrinho-resumo');
    if (resumo) {
        resumo.style.opacity = '0';
        resumo.style.transform = 'translateX(30px)';
        setTimeout(() => {
            resumo.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            resumo.style.opacity = '1';
            resumo.style.transform = 'translateX(0)';
        }, 300);
    }
});

// Fun√ß√£o de fallback para imagens
function imgFallback(el, w=120, h=120, text='Produto') {
    el.onerror = null;
    
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>
      <defs>
        <linearGradient id='bgGrad' x1='0%' y1='0%' x2='100%' y2='100%'>
          <stop offset='0%' style='stop-color:#f8f9fa;stop-opacity:1' />
          <stop offset='100%' style='stop-color:#e9ecef;stop-opacity:1' />
        </linearGradient>
        <linearGradient id='iconGrad' x1='0%' y1='0%' x2='100%' y2='100%'>
          <stop offset='0%' style='stop-color:#e67e22;stop-opacity:0.3' />
          <stop offset='100%' style='stop-color:#f39c12;stop-opacity:0.3' />
        </linearGradient>
      </defs>
      <rect width='100%' height='100%' fill='url(#bgGrad)'/>
      <g transform='translate(${w/2-20}, ${h/2-20})'>
        <rect x='0' y='10' width='40' height='30' rx='3' fill='url(#iconGrad)' stroke='#6c757d' stroke-width='1.5'/>
        <circle cx='30' cy='18' r='3' fill='#6c757d'/>
        <polygon points='5,30 15,20 25,25 32,22 32,35 5,35' fill='#6c757d'/>
      </g>
      <text x='50%' y='${h-8}' text-anchor='middle' font-family='Inter, sans-serif' font-size='10' fill='#6c757d' font-weight='600'>${text}</text>
    </svg>`;
    
    el.src = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
    el.className += ' img-fallback';
}
</script>

{% endblock %}