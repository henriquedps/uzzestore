{% extends "base.html" %}{% extends "base.html" %}



{% block title %}Carrinho - UzzerStore{% endblock %}{% block title %}Carrinho - UzzerStore{% endblock %}



{% block content %}{% block head %}

<div class="container" style="padding: 40px 20px; max-width: 1200px; margin: 0 auto;"><link rel="stylesheet" href="{{ url_for('static', filename='css/modern-cart.css') }}">

    <h1 style="text-align: center; color: #fff; margin-bottom: 40px; font-size: 2.5rem;">{% endblock %}

        üõí Seu Carrinho

    </h1>{% block content %}

    <!-- Header do Carrinho -->

    {% if itens and itens|length > 0 %}<div class="cart-header">

        <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; border: 1px solid rgba(255,255,255,0.2);">    <h1>üõí Minha Sacola</h1>

            {% for item in itens %}    <div class="cart-breadcrumb">

            <div style="display: flex; align-items: center; gap: 20px; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;">        <a href="{{ url_for('index') }}">In√≠cio</a> > 

                <div style="width: 100px; height: 100px; border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.1);">        <a href="{{ url_for('index') }}">Produtos</a> > 

                    <img src="{{ item.produto.imagem }}" alt="{{ item.produto.nome }}"         <span>Carrinho</span>

                         style="width: 100%; height: 100%; object-fit: cover;"    </div>

                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMUExQTFBIi8+CjxwYXRoIGQ9Ik00MCA0MEg2MFY2MEg0MFY0MFoiIGZpbGw9IiM0NDRENEY0Ii8+Cjwvc3ZnPgo=';"></div>

                </div>

                <div class="carrinho-container">

                <div style="flex: 1;">    

                    <h3 style="color: #fff; margin: 0 0 10px 0; font-size: 1.2rem;">{{ item.produto.nome }}</h3>    {% with messages = get_flashed_messages(with_categories=true) %}

                    <p style="color: rgba(255,255,255,0.7); margin: 5px 0;">        {% if messages %}

                        Tamanho: {{ item.tamanho }} | Cor: {{ item.cor }}            {% for category, message in messages %}

                    </p>                <div class="alert alert-{{ category }}">{{ message }}</div>

                    <p style="color: var(--primary-color); font-weight: 600; font-size: 1.1rem; margin: 10px 0;">            {% endfor %}

                        R$ {{ "%.2f"|format(item.produto.preco) }}        {% endif %}

                    </p>    {% endwith %}

                </div>

                    {% if itens %}

                <div style="display: flex; align-items: center; gap: 15px;">        <div class="carrinho-content">

                    <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">            <div class="itens-carrinho">

                        <button onclick="alterarQuantidade({{ item.produto.id }}, '{{ item.tamanho }}', '{{ item.cor }}', -1)"                {% for item in itens %}

                                style="width: 40px; height: 40px; background: none; border: none; color: #fff; cursor: pointer; font-size: 18px;">-</button>                    <div class="item-carrinho" data-produto-id="{{ item.produto.id }}" data-tamanho="{{ item.tamanho }}" data-cor="{{ item.cor }}">

                        <span style="padding: 0 15px; color: #fff; font-weight: 600;">{{ item.quantidade }}</span>                        <div class="item-imagem-container">

                        <button onclick="alterarQuantidade({{ item.produto.id }}, '{{ item.tamanho }}', '{{ item.cor }}', 1)"                            {% if item.produto.imagem %}

                                style="width: 40px; height: 40px; background: none; border: none; color: #fff; cursor: pointer; font-size: 18px;">+</button>                                <img src="{{ item.produto.imagem }}" alt="{{ item.produto.nome }}" class="item-imagem"

                    </div>                                     onerror="imgFallback(this, 120, 120, 'Produto')">

                                                {% else %}

                    <button onclick="removerItem({{ item.produto.id }}, '{{ item.tamanho }}', '{{ item.cor }}')"                                <div class="item-sem-imagem">üëï</div>

                            style="width: 40px; height: 40px; background: rgba(255,0,0,0.2); border: 1px solid rgba(255,0,0,0.5); border-radius: 8px; color: #ff4757; cursor: pointer;">                            {% endif %}

                        üóëÔ∏è                        </div>

                    </button>                        

                </div>                        <div class="item-info">

                                            <h3>{{ item.produto.nome }}</h3>

                <div style="text-align: right; min-width: 100px;">                            <p class="item-preco">{{ item.produto.preco|currency }}</p>

                    <p style="color: #fff; font-weight: 700; font-size: 1.2rem; margin: 0;">                            <div class="item-detalhes">

                        R$ {{ "%.2f"|format(item.produto.preco * item.quantidade) }}                                <span class="item-tamanho">Tam: {{ item.tamanho or 'M' }}</span>

                    </p>                                <span class="item-cor">Cor: {{ item.cor or 'Padr√£o' }}</span>

                </div>                            </div>

            </div>                        </div>

            {% endfor %}                        

                                    <div class="item-quantidade-container">

            <div style="text-align: right; padding: 20px 0; border-top: 2px solid rgba(255,255,255,0.2);">                            <div class="quantidade-controls">

                <h2 style="color: #fff; margin: 0; font-size: 2rem;">                                <button class="btn-quantidade" data-delta="-1">‚àí</button>

                    Total: <span style="color: var(--primary-color);">R$ {{ "%.2f"|format(total) }}</span>                                <span class="quantidade-display">{{ item.quantidade }}</span>

                </h2>                                <button class="btn-quantidade" data-delta="1">+</button>

            </div>                            </div>

                                    </div>

            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">                        

                <a href="{{ url_for('index') }}"                         <div class="item-subtotal">

                   style="padding: 15px 30px; background: rgba(255,255,255,0.1); color: #fff; text-decoration: none; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease;">                            <p class="subtotal-valor">{{ item.subtotal|currency }}</p>

                    ‚Üê Continuar Comprando                            <button class="btn-remover">

                </a>                                üóëÔ∏è Remover

                                            </button>

                <a href="{{ url_for('checkout') }}"                         </div>

                   style="padding: 15px 30px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: #000; text-decoration: none; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;">                    </div>

                    Finalizar Compra ‚Üí                {% endfor %}

                </a>            </div>

                            

                <button onclick="limparCarrinho()"            <div class="carrinho-resumo">

                        style="padding: 15px 30px; background: rgba(255,0,0,0.2); color: #ff4757; border: 1px solid rgba(255,0,0,0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">                <div class="resumo-card">

                    Limpar Carrinho                    <h3>üìã Resumo do Pedido</h3>

                </button>                    

            </div>                    <!-- Cupom de Desconto -->

        </div>                    <div class="cupom-section">

    {% else %}                        <h4>üé´ Cupom de Desconto</h4>

        <div style="text-align: center; padding: 80px 20px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);">                        <div class="cupom-input-group">

            <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">üõí</div>                            <input type="text" class="cupom-input" placeholder="Digite seu cupom" id="cupom-input">

            <h2 style="color: #fff; margin-bottom: 15px;">Seu carrinho est√° vazio</h2>                            <button class="btn-cupom" onclick="aplicarCupom()">Aplicar</button>

            <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">                        </div>

                Adicione produtos incr√≠veis e volte aqui para finalizar sua compra!                    </div>

            </p>                    

            <a href="{{ url_for('index') }}"                     <div class="resumo-linha">

               style="padding: 15px 30px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: #000; text-decoration: none; border-radius: 12px; font-weight: 600; display: inline-block;">                        <span>Subtotal ({{ itens|length }} {{ 'item' if itens|length == 1 else 'itens' }}):</span>

                Ver Produtos                        <span>{{ total|currency }}</span>

            </a>                    </div>

        </div>                    <div class="resumo-linha">

    {% endif %}                        <span>Frete:</span>

</div>                        <span class="resumo-frete">GR√ÅTIS</span>

                    </div>

<script>                    <div class="resumo-linha" style="display: none;" id="desconto-linha">

function alterarQuantidade(produtoId, tamanho, cor, delta) {                        <span>Desconto:</span>

    fetch(`/carrinho/alterar-quantidade/${produtoId}`, {                        <span id="desconto-valor">R$ 0,00</span>

        method: 'POST',                    </div>

        headers: {                    

            'Content-Type': 'application/json',                    <div class="resumo-total">

        },                        <div class="resumo-linha">

        body: JSON.stringify({                            <span>Total:</span>

            tamanho: tamanho,                            <span id="total-final">{{ total|currency }}</span>

            cor: cor,                        </div>

            delta: delta                    </div>

        })                    

    })                    {% if session.user_id %}

    .then(response => response.json())                        <a href="{{ url_for('checkout') }}" class="btn-checkout">

    .then(data => {                            ÔøΩ Ir para a Entrega

        if (data.success) {                        </a>

            location.reload();                    {% else %}

        } else {                        <div class="login-necessario">

            alert('Erro ao alterar quantidade');                            <p>Fa√ßa login para finalizar a compra</p>

        }                            <a href="{{ url_for('login') }}" class="btn-login-checkout">

    })                                üîê Fazer Login

    .catch(error => {                            </a>

        console.error('Erro:', error);                            <p style="font-size: 0.9rem; margin-top: 10px; color: #666;">

        alert('Erro ao alterar quantidade');                                N√£o tem conta? <a href="{{ url_for('cadastro') }}" style="color: #e67e22; text-decoration: none;">Cadastre-se aqui</a>

    });                            </p>

}                        </div>

                    {% endif %}

function removerItem(produtoId, tamanho, cor) {                    

    if (confirm('Remover este item do carrinho?')) {                    <button class="btn-limpar" onclick="limparCarrinho()">

        fetch(`/carrinho/remover/${produtoId}`, {                        üóëÔ∏è Limpar Carrinho

            method: 'POST',                    </button>

            headers: {                </div>

                'Content-Type': 'application/json',            </div>

            },        </div>

            body: JSON.stringify({    {% else %}

                tamanho: tamanho,        <div class="carrinho-vazio">

                cor: cor            <h2>üòî Sua sacola est√° vazia</h2>

            })            <p>Que tal adicionar alguns produtos incr√≠veis?</p>

        })            <a href="{{ url_for('index') }}" class="btn-comprar">üõçÔ∏è Ver Produtos</a>

        .then(response => response.json())        </div>

        .then(data => {    {% endif %}

            if (data.success) {</div>

                location.reload();

            } else {<script>

                alert('Erro ao remover item');// Atualiza quantidade via endpoint, considerando varia√ß√µes

            }async function updateQuantity(produtoId, tamanho, cor, delta) {

        })    try {

        .catch(error => {        const params = new URLSearchParams({ delta: String(delta), tamanho: tamanho || 'M', cor: cor || 'Padr√£o', ajax: '1' });

            console.error('Erro:', error);        const resp = await fetch(`/carrinho/alterar-quantidade/${produtoId}?${params.toString()}`, { headers: { 'Content-Type': 'application/json' } });

            alert('Erro ao remover item');        if (!resp.ok) throw new Error('Falha ao atualizar quantidade');

        });        // Recarrega a p√°gina para refletir totais e itens

    }        location.reload();

}    } catch (e) {

        alert('Erro ao atualizar quantidade.');

function limparCarrinho() {        console.error(e);

    if (confirm('Limpar todo o carrinho?')) {    }

        window.location.href = '{{ url_for("carrinho_limpar") }}';}

    }

}// Remove item considerando varia√ß√µes

</script>async function removeItem(produtoId, tamanho, cor) {

{% endblock %}    if (!confirm('Tem certeza que deseja remover este item?')) return;
    try {
        const params = new URLSearchParams({ tamanho: tamanho || 'M', cor: cor || 'Padr√£o', ajax: '1' });
        const resp = await fetch(`/carrinho/remover/${produtoId}?${params.toString()}`, { headers: { 'Content-Type': 'application/json' } });
        if (!resp.ok) throw new Error('Falha ao remover item');
        location.reload();
    } catch (e) {
        alert('Erro ao remover item.');
        console.error(e);
    }
}

// Fun√ß√£o para limpar carrinho
function limparCarrinho() {
    if (confirm('Tem certeza que deseja limpar todo o carrinho?')) {
        window.location.href = '{{ url_for("carrinho_limpar") }}';
    }
}

// Fun√ß√£o para aplicar cupom
function aplicarCupom() {
    const cupomInput = document.getElementById('cupom-input');
    const cupom = cupomInput.value.trim().toUpperCase();
    
    if (!cupom) {
        alert('Digite um cupom v√°lido');
        return;
    }
    
    // Simular aplica√ß√£o de cupom
    const cuponsValidos = {
        'DESCONTO10': 0.10,
        'BEMVINDO': 0.15,
        'FRETEGRATIS': 0.05
    };
    
    if (cuponsValidos[cupom]) {
        const desconto = cuponsValidos[cupom];
        const total = parseFloat('{{ total }}'.replace(',', '.'));
        const valorDesconto = total * desconto;
        const novoTotal = total - valorDesconto;
        
        // Mostrar desconto
        document.getElementById('desconto-linha').style.display = 'flex';
        document.getElementById('desconto-valor').textContent = `- R$ ${valorDesconto.toFixed(2).replace('.', ',')}`;
        document.getElementById('total-final').textContent = `R$ ${novoTotal.toFixed(2).replace('.', ',')}`;
        
        // Feedback visual
        cupomInput.style.borderColor = '#27ae60';
        cupomInput.style.backgroundColor = '#d4edda';
        
        alert(`Cupom aplicado! Desconto de ${(desconto * 100)}%`);
    } else {
        // Cupom inv√°lido
        cupomInput.style.borderColor = '#e74c3c';
        cupomInput.style.backgroundColor = '#f8d7da';
        alert('Cupom inv√°lido ou expirado');
        
        // Resetar ap√≥s 3 segundos
        setTimeout(() => {
            cupomInput.style.borderColor = '#e9ecef';
            cupomInput.style.backgroundColor = 'white';
        }, 3000);
    }
}

// Mantido apenas para compatibilidade visual, n√£o usado pois recarregamos a p√°gina
function updateItemSubtotal() {}

// Anima√ß√µes na entrada da p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Animar entrada dos itens
    const items = document.querySelectorAll('.item-carrinho');
    items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        setTimeout(() => {
            item.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Animar resumo
    const resumo = document.querySelector('.carrinho-resumo');
    if (resumo) {
        resumo.style.opacity = '0';
        resumo.style.transform = 'translateX(30px)';
        setTimeout(() => {
            resumo.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            resumo.style.opacity = '1';
            resumo.style.transform = 'translateX(0)';
        }, 300);
    }

    // Adiciona eventos aos bot√µes de quantidade e remover sem usar inline handlers
    document.querySelectorAll('.item-carrinho').forEach((card) => {
        const produtoId = card.getAttribute('data-produto-id');
        const tamanho = card.getAttribute('data-tamanho') || 'M';
        const cor = card.getAttribute('data-cor') || 'Padr√£o';

        card.querySelectorAll('.btn-quantidade').forEach((btn) => {
            const delta = parseInt(btn.getAttribute('data-delta') || '0');
            btn.addEventListener('click', () => updateQuantity(produtoId, tamanho, cor, delta));
        });

        const btnRemover = card.querySelector('.btn-remover');
        if (btnRemover) {
            btnRemover.addEventListener('click', () => removeItem(produtoId, tamanho, cor));
        }
    });
});

// Fun√ß√£o de fallback para imagens
function imgFallback(el, w=120, h=120, text='Produto') {
    el.onerror = null;
    
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>
      <defs>
        <linearGradient id='bgGrad' x1='0%' y1='0%' x2='100%' y2='100%'>
          <stop offset='0%' style='stop-color:#f8f9fa;stop-opacity:1' />
          <stop offset='100%' style='stop-color:#e9ecef;stop-opacity:1' />
        </linearGradient>
        <linearGradient id='iconGrad' x1='0%' y1='0%' x2='100%' y2='100%'>
          <stop offset='0%' style='stop-color:#e67e22;stop-opacity:0.3' />
          <stop offset='100%' style='stop-color:#f39c12;stop-opacity:0.3' />
        </linearGradient>
      </defs>
      <rect width='100%' height='100%' fill='url(#bgGrad)'/>
      <g transform='translate(${w/2-20}, ${h/2-20})'>
        <rect x='0' y='10' width='40' height='30' rx='3' fill='url(#iconGrad)' stroke='#6c757d' stroke-width='1.5'/>
        <circle cx='30' cy='18' r='3' fill='#6c757d'/>
        <polygon points='5,30 15,20 25,25 32,22 32,35 5,35' fill='#6c757d'/>
      </g>
      <text x='50%' y='${h-8}' text-anchor='middle' font-family='Inter, sans-serif' font-size='10' fill='#6c757d' font-weight='600'>${text}</text>
    </svg>`;
    
    el.src = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
    el.className += ' img-fallback';
}
</script>

{% endblock %}