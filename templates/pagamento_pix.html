{% extends "base.html" %}

{% block title %}Pagamento PIX - UzzerStore{% endblock %}

{% block head %}
<style>
    .pagamento-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #fff;
        min-height: 80vh;
    }

    .pagamento-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px 0;
        border-bottom: 2px solid #f0f0f0;
    }

    .pagamento-header h1 {
        color: #7c3aed;
        font-size: 2.2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .pagamento-header .pix-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #00bb9c, #32c8a8);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
    }

    .status-pedido {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        margin-bottom: 30px;
        text-align: center;
        font-weight: 600;
    }

    .pix-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-bottom: 40px;
    }

    .qr-section {
        text-align: center;
        background: #f8fafc;
        padding: 30px;
        border-radius: 16px;
        border: 2px solid #e5e7eb;
    }

    .qr-code {
        width: 200px;
        height: 200px;
        background: white;
        border: 2px solid #d1d5db;
        border-radius: 12px;
        margin: 0 auto 20px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #6b7280;
        position: relative;
        overflow: hidden;
    }

    .qr-placeholder {
        text-align: center;
        color: #6b7280;
    }

    .codigo-pix {
        background: #fff;
        border: 2px solid #7c3aed;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        word-break: break-all;
        margin-bottom: 15px;
        position: relative;
    }

    .btn-copiar {
        background: #7c3aed;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
    }

    .btn-copiar:hover {
        background: #6d28d9;
        transform: translateY(-2px);
    }

    .btn-copiar.copiado {
        background: #10b981;
    }

    .detalhes-pedido {
        background: #f8fafc;
        padding: 30px;
        border-radius: 16px;
        border: 2px solid #e5e7eb;
    }

    .detalhes-titulo {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .detalhe-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .detalhe-item:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
        padding-top: 20px;
        border-top: 2px solid #7c3aed;
    }

    .detalhe-label {
        color: #6b7280;
        font-weight: 500;
    }

    .detalhe-valor {
        color: #1f2937;
        font-weight: 600;
    }

    .instrucoes-pix {
        background: #fef3c7;
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
    }

    .instrucoes-titulo {
        color: #d97706;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .instrucoes-lista {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .instrucoes-lista li {
        color: #92400e;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .instrucoes-lista li::before {
        content: "‚úì";
        background: #f59e0b;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        flex-shrink: 0;
    }

    .tempo-expiracao {
        background: #fef2f2;
        border: 2px solid #f87171;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        margin-bottom: 30px;
    }

    .cronometro {
        font-size: 1.5rem;
        font-weight: 700;
        color: #dc2626;
        margin-bottom: 10px;
    }

    .acoes-pagamento {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 40px;
    }

    .btn-acao {
        padding: 15px 25px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-voltar {
        background: #6b7280;
        color: white;
    }

    .btn-voltar:hover {
        background: #4b5563;
        transform: translateY(-2px);
    }

    .btn-verificar {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .btn-verificar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    .status-verificacao {
        background: #e0f2fe;
        border: 2px solid #29b6f6;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        margin-top: 30px;
        display: none;
    }

    .loading-verification {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        color: #0277bd;
        font-weight: 600;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e3f2fd;
        border-top: 2px solid #0277bd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .pagamento-container {
            margin: 20px auto;
            padding: 15px;
        }

        .pix-content {
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .qr-code {
            width: 180px;
            height: 180px;
        }

        .acoes-pagamento {
            grid-template-columns: 1fr;
        }

        .pagamento-header h1 {
            font-size: 1.8rem;
            flex-direction: column;
            gap: 10px;
        }
    }

    /* Anima√ß√µes */
    .fade-in {
        animation: fadeIn 0.6s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="pagamento-container fade-in">
    <div class="pagamento-header">
        <h1>
            <div class="pix-icon">PIX</div>
            Pagamento via PIX
        </h1>
        <p>Pedido #{{ pedido.id }} - {{ pedido.nome_cliente }}</p>
    </div>

    <div class="status-pedido">
        ‚úÖ Pedido criado com sucesso! Aguardando confirma√ß√£o do pagamento.
    </div>

    <div class="tempo-expiracao">
        <div class="cronometro" id="cronometro">29:59</div>
        <p>‚è∞ Tempo limite para pagamento</p>
    </div>

    <div class="pix-content">
        <div class="qr-section">
            <h3>üì± Escaneie o QR Code</h3>
            <div class="qr-code pulse">
                <div class="qr-placeholder">
                    üì±<br>
                    QR Code PIX<br>
                    <small>R$ {{ "%.2f"|format(pedido.total) }}</small>
                </div>
            </div>

            <h4>üîó Ou copie o c√≥digo:</h4>
            <div class="codigo-pix" id="codigoPix">
                {{ codigo_pix }}
            </div>
            <button class="btn-copiar" onclick="copiarCodigo()">
                üìã Copiar C√≥digo PIX
            </button>
        </div>

        <div class="detalhes-pedido">
            <h3 class="detalhes-titulo">
                üìã Detalhes do Pedido
            </h3>
            
            {% set itens = pedido.itens | fromjson %}
            {% for item in itens %}
            <div class="detalhe-item">
                <span class="detalhe-label">{{ item.nome }} ({{ item.quantidade }}x)</span>
                <span class="detalhe-valor">R$ {{ "%.2f"|format(item.preco * item.quantidade) }}</span>
            </div>
            {% endfor %}
            
            <div class="detalhe-item">
                <span class="detalhe-label">Frete</span>
                <span class="detalhe-valor">R$ 15,00</span>
            </div>
            
            <div class="detalhe-item">
                <span class="detalhe-label">Total</span>
                <span class="detalhe-valor">R$ {{ "%.2f"|format(pedido.total) }}</span>
            </div>
        </div>
    </div>

    <div class="instrucoes-pix">
        <h3 class="instrucoes-titulo">
            üí° Como pagar com PIX
        </h3>
        <ul class="instrucoes-lista">
            <li>Abra o app do seu banco</li>
            <li>Escolha a op√ß√£o PIX</li>
            <li>Escaneie o QR Code ou cole o c√≥digo</li>
            <li>Confirme os dados e o valor</li>
            <li>Finalize o pagamento</li>
            <li>Guarde o comprovante</li>
        </ul>
    </div>

    <div class="status-verificacao" id="statusVerificacao">
        <div class="loading-verification">
            <div class="spinner"></div>
            Verificando pagamento...
        </div>
    </div>

    <div class="acoes-pagamento">
        <a href="{{ url_for('index') }}" class="btn-acao btn-voltar">
            ‚¨ÖÔ∏è Voltar √† Loja
        </a>
        <button class="btn-acao btn-verificar" onclick="verificarPagamento()">
            üîÑ Verificar Pagamento
        </button>
    </div>
</div>

<script>
// Cron√¥metro de expira√ß√£o (30 minutos)
let tempoRestante = 30 * 60; // 30 minutos em segundos

function atualizarCronometro() {
    const minutos = Math.floor(tempoRestante / 60);
    const segundos = tempoRestante % 60;
    
    document.getElementById('cronometro').textContent = 
        `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    
    if (tempoRestante <= 0) {
        document.getElementById('cronometro').textContent = "EXPIRADO";
        document.getElementById('cronometro').style.color = "#dc2626";
        clearInterval(cronometroInterval);
        
        // Desabilitar bot√µes
        document.querySelector('.btn-verificar').disabled = true;
        document.querySelector('.btn-copiar').disabled = true;
    }
    
    tempoRestante--;
}

// Iniciar cron√¥metro
const cronometroInterval = setInterval(atualizarCronometro, 1000);
atualizarCronometro(); // Executar imediatamente

function copiarCodigo() {
    const codigo = document.getElementById('codigoPix').textContent;
    
    navigator.clipboard.writeText(codigo).then(() => {
        const btn = document.querySelector('.btn-copiar');
        btn.textContent = '‚úÖ C√≥digo Copiado!';
        btn.classList.add('copiado');
        
        setTimeout(() => {
            btn.textContent = 'üìã Copiar C√≥digo PIX';
            btn.classList.remove('copiado');
        }, 3000);
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('Erro ao copiar c√≥digo. Tente selecionar e copiar manualmente.');
    });
}

function verificarPagamento() {
    const statusDiv = document.getElementById('statusVerificacao');
    statusDiv.style.display = 'block';
    
    // Simular verifica√ß√£o (aqui voc√™ faria uma requisi√ß√£o real para a API)
    fetch('/verificar-pagamento-pix', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            pedido_id: '{{ pedido.id }}',
            codigo_pix: '{{ codigo_pix }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        statusDiv.style.display = 'none';
        
        if (data.pago) {
            alert('‚úÖ Pagamento confirmado! Redirecionando...');
            window.location.href = '/pedido-sucesso/{{ pedido.id }}';
        } else {
            alert('‚è≥ Pagamento ainda n√£o identificado. Tente novamente em alguns minutos.');
        }
    })
    .catch(error => {
        console.error('Erro na verifica√ß√£o:', error);
        statusDiv.style.display = 'none';
        alert('‚ùå Erro ao verificar pagamento. Tente novamente.');
    });
}

// Verifica√ß√£o autom√°tica a cada 30 segundos
setInterval(() => {
    if (tempoRestante > 0) {
        verificarPagamento();
    }
}, 30000);

// Adicionar efeitos visuais
document.addEventListener('DOMContentLoaded', function() {
    // Efeito de fade-in nos elementos
    const elementos = document.querySelectorAll('.detalhe-item, .instrucoes-lista li');
    elementos.forEach((el, index) => {
        setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateX(-20px)';
            el.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                el.style.opacity = '1';
                el.style.transform = 'translateX(0)';
            }, 100);
        }, index * 100);
    });
});

// Evitar refresh da p√°gina
window.addEventListener('beforeunload', function(e) {
    if (tempoRestante > 0) {
        e.preventDefault();
        e.returnValue = 'Tem certeza que deseja sair? Seu pagamento PIX ainda est√° pendente.';
    }
});

// Debug: Simular pagamento ap√≥s 10 segundos (remover em produ√ß√£o)
setTimeout(() => {
    console.log('üîÑ Simula√ß√£o: Verificando pagamento automaticamente...');
    // Descomentar para simular pagamento autom√°tico:
    // window.location.href = '/pedido-sucesso/{{ pedido.id }}';
}, 10000);
</script>
{% endblock %}