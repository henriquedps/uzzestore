{% extends "base.html" %}

{% block title %}UzzerStore - Moda com Estilo{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <h1 class="hero-title">Busque sua inspira√ß√£o de visual</h1>
    <p class="hero-subtitle">Descubra as √∫ltimas tend√™ncias em moda</p>
</section>

<!-- Filter Section -->
<section class="filter-section">
    <div class="filter-left">
        <button class="filter-toggle" onclick="toggleFilters()">
            <i class="fas fa-sliders-h"></i> Mostrar filtros
        </button>
        <span class="product-count">{{ produtos|length }} produto{{ 's' if produtos|length != 1 else '' }}</span>
    </div>
    <div class="filter-right">
        <label class="sort-label">Ordenar por:</label>
        <select class="sort-dropdown" onchange="sortProducts(this.value)">
            <option value="destaque">Em destaque</option>
            <option value="menor-preco">Menor pre√ßo</option>
            <option value="maior-preco">Maior pre√ßo</option>
            <option value="nome-az">Nome A-Z</option>
            <option value="nome-za">Nome Z-A</option>
            <option value="mais-novos">Mais novos</option>
        </select>
    </div>
</section>

<!-- Panel de Filtros -->
<div class="filters-panel" id="filters-panel">
    <div class="filters-container">
        <div class="filters-header">
            <h3>üîç Filtros</h3>
            <button class="close-filters" onclick="toggleFilters()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="filters-content">
            <!-- Filtro por Categoria -->
            <div class="filter-group">
                <h4>Categoria</h4>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" value="" onchange="filterProducts()" checked>
                        <span class="checkmark"></span>
                        Todas as categorias
                    </label>
                    {% for categoria in categorias %}
                    <label class="filter-option">
                        <input type="checkbox" value="{{ categoria.categoria }}" onchange="filterProducts()">
                        <span class="checkmark"></span>
                        {{ categoria.categoria }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Filtro por Pre√ßo -->
            <div class="filter-group">
                <h4>Faixa de Pre√ßo</h4>
                <div class="price-range">
                    <div class="price-inputs">
                        <div>
                            <label>M√≠n:</label>
                            <input type="number" id="min-price" placeholder="0" min="0" onchange="filterProducts()">
                        </div>
                        <div>
                            <label>M√°x:</label>
                            <input type="number" id="max-price" placeholder="1000" min="0" onchange="filterProducts()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtro por Tamanho -->
            <div class="filter-group">
                <h4>Tamanho</h4>
                <div class="size-options">
                    <label class="size-option">
                        <input type="checkbox" value="" onchange="filterProducts()" checked>
                        <span class="size-checkmark">Todos</span>
                    </label>
                    <label class="size-option">
                        <input type="checkbox" value="PP" onchange="filterProducts()">
                        <span class="size-checkmark">PP</span>
                    </label>
                    <label class="size-option">
                        <input type="checkbox" value="P" onchange="filterProducts()">
                        <span class="size-checkmark">P</span>
                    </label>
                    <label class="size-option">
                        <input type="checkbox" value="M" onchange="filterProducts()">
                        <span class="size-checkmark">M</span>
                    </label>
                    <label class="size-option">
                        <input type="checkbox" value="G" onchange="filterProducts()">
                        <span class="size-checkmark">G</span>
                    </label>
                    <label class="size-option">
                        <input type="checkbox" value="GG" onchange="filterProducts()">
                        <span class="size-checkmark">GG</span>
                    </label>
                    <label class="size-option">
                        <input type="checkbox" value="XG" onchange="filterProducts()">
                        <span class="size-checkmark">XG</span>
                    </label>
                </div>
            </div>

            <!-- Filtros R√°pidos -->
            <div class="filter-group">
                <h4>Filtros R√°pidos</h4>
                <div class="quick-filters">
                    <button class="quick-filter" onclick="setQuickFilter('promocao')">
                        üè∑Ô∏è Promo√ß√£o
                    </button>
                    <button class="quick-filter" onclick="setQuickFilter('lancamento')">
                        ‚≠ê Lan√ßamentos
                    </button>
                    <button class="quick-filter" onclick="setQuickFilter('mais-vendidos')">
                        üî• Mais Vendidos
                    </button>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="filter-actions">
                <button class="btn-clear-filters" onclick="clearAllFilters()">
                    üóëÔ∏è Limpar Filtros
                </button>
                <button class="btn-apply-filters" onclick="toggleFilters()">
                    ‚úÖ Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Products Section -->
<section class="products-container">
    <div class="products-header">
        <div class="active-filters" id="active-filters" style="display: none;">
            <span class="active-filters-label">Filtros ativos:</span>
            <div class="active-filters-list" id="active-filters-list"></div>
        </div>
    </div>

    {% if produtos %}
        <div class="products-grid" id="products-grid">
            {% for produto in produtos %}
                <div class="product-card" 
                     data-categoria="{{ produto.categoria or '' }}" 
                     data-preco="{{ produto.preco }}" 
                     data-nome="{{ produto.nome|lower }}"
                     data-id="{{ produto.id }}">
                    <div class="product-image">
                        {% if produto.imagem %}
                            <img src="{{ produto.imagem }}" 
                                 alt="{{ produto.nome }}" 
                                 loading="lazy"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400/f0f0f0/666?text=Sem+Imagem';">
                        {% else %}
                            <div class="product-placeholder">
                                <i class="fas fa-image"></i>
                                <p>Sem imagem</p>
                            </div>
                        {% endif %}
                        
                        <!-- Overlay melhorado -->
                        <div class="product-overlay">
                            <div class="overlay-content">
                                <button class="quick-view-btn" onclick="quickView({{ produto.id }})">
                                    <i class="fas fa-eye"></i>
                                    <span>Visualiza√ß√£o R√°pida</span>
                                </button>
                                
                                <div class="quick-actions">
                                    {% if session.user_id %}
                                        <button class="quick-cart-btn" onclick="addToCart({{ produto.id }}, '{{ produto.nome }}')" title="Adicionar ao Carrinho">
                                            <i class="fas fa-shopping-bag"></i>
                                        </button>
                                        <button class="quick-wishlist-btn" onclick="addToWishlist({{ produto.id }})" title="Adicionar aos Favoritos">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                    {% else %}
                                        <a href="{{ url_for('login') }}" class="quick-login-btn" title="Fazer Login">
                                            <i class="fas fa-sign-in-alt"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="product-info">
                        <h3 class="product-name">{{ produto.nome }}</h3>
                        {% if produto.categoria %}
                            <span class="product-category">{{ produto.categoria }}</span>
                        {% endif %}
                        <div class="product-price">{{ produto.preco|currency }}</div>
                        
                        {% if session.user_id %}
                            <button onclick="addToCart({{ produto.id }}, '{{ produto.nome }}')" class="btn-add-cart">
                                <i class="fas fa-shopping-bag"></i> Adicionar ao Carrinho
                            </button>
                        {% else %}
                            <a href="{{ url_for('login') }}" class="btn-add-cart">
                                <i class="fas fa-sign-in-alt"></i> Fazer Login para Comprar
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Mensagem quando n√£o h√° produtos filtrados -->
        <div class="no-products-message" id="no-products" style="display: none;">
            <div style="text-align: center; padding: 80px 20px; color: #666;">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3>Nenhum produto encontrado</h3>
                <p>Tente ajustar os filtros ou buscar por outros termos</p>
                <button onclick="clearAllFilters()" class="btn-clear-filters" style="margin-top: 20px;">
                    üîÑ Limpar todos os filtros
                </button>
            </div>
        </div>
    {% else %}
        <div style="text-align: center; padding: 80px 20px; color: #666;">
            <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3>Nenhum produto cadastrado</h3>
            <p>Em breve novos produtos incr√≠veis!</p>
        </div>
    {% endif %}
</section>

<!-- Modal de Visualiza√ß√£o R√°pida -->
<div class="quick-view-modal" id="quick-view-modal">
    <div class="modal-overlay" onclick="closeQuickView()"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeQuickView()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="modal-body">
            <div class="product-image-section">
                <img id="modal-product-image" src="" alt="" class="modal-product-img">
            </div>
            
            <div class="product-details-section">
                <div class="product-header">
                    <span id="modal-product-category" class="modal-category"></span>
                    <h2 id="modal-product-name" class="modal-title"></h2>
                    <div id="modal-product-price" class="modal-price"></div>
                </div>
                
                <div class="product-description">
                    <h3>Descri√ß√£o</h3>
                    <p id="modal-product-description">Produto de alta qualidade com excelente acabamento e conforto.</p>
                </div>
                
                <div class="product-sizes">
                    <h3>Tamanhos dispon√≠veis</h3>
                    <div class="size-selector">
                        <button class="size-btn" onclick="selectSize('PP')">PP</button>
                        <button class="size-btn" onclick="selectSize('P')">P</button>
                        <button class="size-btn active" onclick="selectSize('M')">M</button>
                        <button class="size-btn" onclick="selectSize('G')">G</button>
                        <button class="size-btn" onclick="selectSize('GG')">GG</button>
                        <button class="size-btn" onclick="selectSize('XG')">XG</button>
                    </div>
                </div>
                
                <div class="product-actions">
                    {% if session.user_id %}
                        <button id="modal-add-cart" class="btn-modal-cart" onclick="addToCartFromModal()">
                            <i class="fas fa-shopping-bag"></i> Adicionar ao Carrinho
                        </button>
                        <button class="btn-modal-wishlist" onclick="addToWishlist()">
                            <i class="fas fa-heart"></i> Favoritar
                        </button>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="btn-modal-cart">
                            <i class="fas fa-sign-in-alt"></i> Fazer Login para Comprar
                        </a>
                    {% endif %}
                </div>
                
                <div class="product-info">
                    <div class="info-item">
                        <i class="fas fa-truck"></i>
                        <span>Frete gr√°tis para compras acima de R$ 150</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>Compra 100% segura e garantida</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-redo-alt"></i>
                        <span>Troca gr√°tis em at√© 30 dias</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para o sistema de filtros */
.filters-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 20px rgba(0,0,0,0.1);
    z-index: 2000;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.filters-panel.active {
    right: 0;
}

.filters-container {
    padding: 0;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px;
    border-bottom: 1px solid var(--border-light);
    background: var(--secondary-color);
}

.filters-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.2rem;
}

.close-filters {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 8px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.close-filters:hover {
    background: var(--border-light);
    color: var(--text-primary);
}

.filters-content {
    flex: 1;
    padding: 25px;
}

.filter-group {
    margin-bottom: 30px;
}

.filter-group h4 {
    margin-bottom: 15px;
    color: var(--text-primary);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.filter-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.filter-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 8px 0;
    transition: all 0.3s ease;
}

.filter-option:hover {
    color: var(--accent-color);
}

.filter-option input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border-light);
    border-radius: 4px;
    margin-right: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.filter-option input[type="checkbox"]:checked + .checkmark {
    background: var(--accent-color);
    border-color: var(--accent-color);
}

.filter-option input[type="checkbox"]:checked + .checkmark::after {
    content: "‚úì";
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.price-range {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.price-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.price-inputs div {
    display: flex;
    flex-direction: column;
}

.price-inputs label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.price-inputs input {
    padding: 8px 12px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 14px;
}

.size-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 10px;
}

.size-option {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.size-option input[type="checkbox"] {
    display: none;
}

.size-checkmark {
    width: 40px;
    height: 40px;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    background: white;
    color: var(--text-secondary);
}

.size-option:hover .size-checkmark {
    border-color: var(--accent-color);
    color: var(--accent-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.size-option input[type="checkbox"]:checked + .size-checkmark {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

/* Estilo especial para "Todos" */
.size-option:first-child .size-checkmark {
    font-size: 10px;
    padding: 0 4px;
}

/* Mobile responsivo para tamanhos */
@media (max-width: 768px) {
    .size-options {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }
    
    .size-checkmark {
        width: 35px;
        height: 35px;
        font-size: 11px;
    }
}

.quick-filters {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.quick-filter {
    background: var(--secondary-color);
    border: 1px solid var(--border-light);
    padding: 10px 15px;
    text-align: left;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 14px;
}

.quick-filter:hover, .quick-filter.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border-light);
}

.btn-clear-filters, .btn-apply-filters {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-clear-filters {
    background: white;
    color: var(--text-secondary);
    border: 1px solid var(--border-light);
}

.btn-clear-filters:hover {
    background: var(--secondary-color);
}

.btn-apply-filters {
    background: var(--primary-color);
    color: white;
    border: 1px solid var(--primary-color);
}

.btn-apply-filters:hover {
    background: var(--accent-color);
    border-color: var(--accent-color);
}

.active-filters {
    background: var(--secondary-color);
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid var(--accent-color);
}

.active-filters-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-right: 10px;
}

.active-filters-list {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 8px;
}

.active-filter-tag {
    background: var(--accent-color);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.active-filter-tag .remove {
    cursor: pointer;
    font-weight: bold;
}

/* Melhorar estilos das imagens dos produtos */
.product-image {
    height: 400px;
    background: var(--secondary-color);
    overflow: hidden;
    position: relative;
    border-radius: 12px 12px 0 0;
    cursor: pointer;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    display: block;
}

.product-card:hover .product-image img {
    transform: scale(1.1);
}

/* Overlay do produto melhorado */
.product-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        135deg,
        rgba(0, 0, 0, 0.7) 0%,
        rgba(0, 0, 0, 0.4) 50%,
        rgba(0, 0, 0, 0.8) 100%
    );
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(2px);
}

.product-card:hover .product-overlay {
    opacity: 1;
    visibility: visible;
}

.overlay-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    transform: translateY(20px);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.product-card:hover .overlay-content {
    transform: translateY(0);
}

/* Bot√£o principal de visualiza√ß√£o r√°pida */
.quick-view-btn {
    background: linear-gradient(135deg, var(--accent-color) 0%, #e6ac00 100%);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 200px;
    justify-content: center;
}

.quick-view-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(212, 175, 55, 0.4);
    background: linear-gradient(135deg, #e6ac00 0%, var(--accent-color) 100%);
}

.quick-view-btn:active {
    transform: translateY(-1px) scale(1.02);
}

.quick-view-btn i {
    font-size: 16px;
}

/* A√ß√µes r√°pidas secund√°rias */
.quick-actions {
    display: flex;
    gap: 15px;
}

.quick-cart-btn,
.quick-wishlist-btn,
.quick-login-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    text-decoration: none;
    font-size: 16px;
}

.quick-cart-btn:hover {
    background: var(--primary-color);
    border-color: var(--primary-color);
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 8px 20px rgba(26, 26, 26, 0.3);
}

.quick-wishlist-btn:hover {
    background: #ff4757;
    border-color: #ff4757;
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 8px 20px rgba(255, 71, 87, 0.3);
}

.quick-login-btn:hover {
    background: var(--accent-color);
    border-color: var(--accent-color);
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
}

/* Efeito de pulse nos bot√µes secund√°rios */
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.quick-actions button:hover {
    animation: pulse 2s infinite;
}

/* Loading state para visualiza√ß√£o r√°pida */
.quick-view-btn.loading {
    pointer-events: none;
    opacity: 0.8;
}

.quick-view-btn.loading i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Responsividade */
@media (max-width: 768px) {
    .quick-view-btn {
        padding: 12px 20px;
        font-size: 12px;
        min-width: 160px;
    }
    
    .quick-view-btn span {
        display: none;
    }
    
    .quick-cart-btn,
    .quick-wishlist-btn,
    .quick-login-btn {
        width: 45px;
        height: 45px;
        font-size: 14px;
    }
    
    .overlay-content {
        gap: 15px;
    }
}

@media (max-width: 480px) {
    .quick-view-btn {
        min-width: 120px;
        padding: 10px 15px;
    }
    
    .quick-actions {
        gap: 10px;
    }
}

/* Efeito especial no hover do card */
.product-card {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.product-card:hover {
    transform: translateY(-8px);
    box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.1),
        0 0 0 1px rgba(212, 175, 55, 0.1);
}

/* Indicador de loading global */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(3px);
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid var(--border-light);
    border-top: 3px solid var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.product-info {
    border-top: 1px solid var(--border-light);
    padding-top: 20px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    font-size: 13px;
    color: var(--text-secondary);
}

.info-item i {
    color: var(--accent-color);
    width: 16px;
}

/* Mobile */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        max-height: 90vh;
    }
    
    .modal-body {
        grid-template-columns: 1fr;
        grid-template-rows: 300px 1fr;
    }
    
    .product-image-section {
        padding: 20px;
    }
    
    .product-details-section {
        padding: 25px 20px;
    }
    
    .modal-title {
        font-size: 1.5rem;
    }
    
    .modal-price {
        font-size: 1.4rem;
    }
    
    .product-actions {
        flex-direction: column;
    }
}
</style>

<script>
let allProducts = [];
let filteredProducts = [];

// Inicializar produtos
document.addEventListener('DOMContentLoaded', function() {
    allProducts = Array.from(document.querySelectorAll('.product-card'));
    filteredProducts = [...allProducts];
});

// Toggle do painel de filtros
function toggleFilters() {
    const panel = document.getElementById('filters-panel');
    const overlay = document.querySelector('.filters-overlay') || createOverlay();
    
    panel.classList.toggle('active');
    overlay.classList.toggle('active');
    
    // Atualizar texto do bot√£o
    const button = document.querySelector('.filter-toggle');
    const isActive = panel.classList.contains('active');
    button.innerHTML = isActive ? 
        '<i class="fas fa-times"></i> Fechar filtros' : 
        '<i class="fas fa-sliders-h"></i> Mostrar filtros';
}

// Criar overlay
function createOverlay() {
    const overlay = document.createElement('div');
    overlay.className = 'filters-overlay';
    overlay.onclick = toggleFilters;
    document.body.appendChild(overlay);
    return overlay;
}

// Obter categorias selecionadas
function getSelectedCategories() {
    const checkboxes = document.querySelectorAll('.filter-option input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Obter faixa de pre√ßo
function getPriceRange() {
    const minPrice = document.getElementById('min-price').value;
    const maxPrice = document.getElementById('max-price').value;
    
    return {
        min: minPrice ? parseFloat(minPrice) : 0,
        max: maxPrice ? parseFloat(maxPrice) : Infinity
    };
}

// Atualizar a fun√ß√£o getSelectedSizes
function getSelectedSizes() {
    const checkboxes = document.querySelectorAll('.size-option input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Atualizar a fun√ß√£o filterProducts
function filterProducts() {
    const selectedCategories = getSelectedCategories();
    const selectedSizes = getSelectedSizes();
    const priceRange = getPriceRange();
    
    filteredProducts = allProducts.filter(product => {
        const categoria = product.dataset.categoria;
        const preco = parseFloat(product.dataset.preco);
        const tamanho = product.dataset.tamanho || ''; // Assumindo que voc√™ vai adicionar data-tamanho
        
        // Filtro de categoria
        const categoryMatch = selectedCategories.length === 0 || 
                             selectedCategories.includes('') || 
                             selectedCategories.includes(categoria);
        
        // Filtro de tamanho
        const sizeMatch = selectedSizes.length === 0 || 
                         selectedSizes.includes('') || 
                         selectedSizes.includes(tamanho);
        
        // Filtro de pre√ßo
        const priceMatch = preco >= priceRange.min && preco <= priceRange.max;
        
        return categoryMatch && sizeMatch && priceMatch;
    });
    
    updateProductsDisplay();
    updateActiveFilters();
    updateProductCount();
}

// Atualizar a fun√ß√£o updateActiveFilters
function updateActiveFilters() {
    const container = document.getElementById('active-filters');
    const list = document.getElementById('active-filters-list');
    
    const selectedCategories = getSelectedCategories().filter(cat => cat !== '');
    const selectedSizes = getSelectedSizes().filter(size => size !== '');
    const priceRange = getPriceRange();
    
    list.innerHTML = '';
    
    // Adicionar filtros de categoria
    selectedCategories.forEach(categoria => {
        if (categoria) {
            addFilterTag(list, `Categoria: ${categoria}`, () => {
                const checkbox = document.querySelector(`input[value="${categoria}"]`);
                checkbox.checked = false;
                filterProducts();
            });
        }
    });
    
    // Adicionar filtros de tamanho
    selectedSizes.forEach(tamanho => {
        if (tamanho) {
            addFilterTag(list, `Tamanho: ${tamanho}`, () => {
                const checkbox = document.querySelector(`.size-option input[value="${tamanho}"]`);
                checkbox.checked = false;
                filterProducts();
            });
        }
    });
    
    // Adicionar filtro de pre√ßo
    if (priceRange.min > 0 || priceRange.max < Infinity) {
        const priceText = `Pre√ßo: R$ ${priceRange.min} - R$ ${priceRange.max === Infinity ? '‚àû' : priceRange.max}`;
        addFilterTag(list, priceText, () => {
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            filterProducts();
        });
    }
    
    container.style.display = list.children.length > 0 ? 'block' : 'none';
}

// Adicionar tag de filtro ativo
function addFilterTag(container, text, removeCallback) {
    const tag = document.createElement('span');
    tag.className = 'active-filter-tag';
    tag.innerHTML = `${text} <span class="remove" onclick="this.parentElement.remove(); arguments[0].stopPropagation();">√ó</span>`;
    tag.querySelector('.remove').onclick = (e) => {
        e.stopPropagation();
        removeCallback();
    };
    container.appendChild(tag);
}

// Atualizar contador de produtos
function updateProductCount() {
    const counter = document.querySelector('.product-count');
    const count = filteredProducts.length;
    counter.textContent = `${count} produto${count !== 1 ? 's' : ''}`;
}

// Ordenar produtos
function sortProducts(sortBy) {
    switch(sortBy) {
        case 'menor-preco':
            filteredProducts.sort((a, b) => parseFloat(a.dataset.preco) - parseFloat(b.dataset.preco));
            break;
        case 'maior-preco':
            filteredProducts.sort((a, b) => parseFloat(b.dataset.preco) - parseFloat(a.dataset.preco));
            break;
        case 'nome-az':
            filteredProducts.sort((a, b) => a.dataset.nome.localeCompare(b.dataset.nome));
            break;
        case 'nome-za':
            filteredProducts.sort((a, b) => b.dataset.nome.localeCompare(a.dataset.nome));
            break;
        case 'mais-novos':
            filteredProducts.sort((a, b) => parseInt(b.dataset.id) - parseInt(a.dataset.id));
            break;
        default:
            // Em destaque - ordem original
            break;
    }
    
    const grid = document.getElementById('products-grid');
    filteredProducts.forEach(product => {
        grid.appendChild(product);
    });
}

// Filtros r√°pidos
function setQuickFilter(type) {
    // Remover active de outros filtros r√°pidos
    document.querySelectorAll('.quick-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Ativar filtro atual
    event.target.classList.add('active');
    
    // L√≥gica espec√≠fica para cada filtro r√°pido
    switch(type) {
        case 'promocao':
            // Simular promo√ß√£o - produtos com pre√ßo menor que 100
            document.getElementById('max-price').value = '100';
            break;
        case 'lancamento':
            // Ordenar por mais novos
            document.querySelector('.sort-dropdown').value = 'mais-novos';
            sortProducts('mais-novos');
            break;
        case 'mais-vendidos':
            // Ordenar por destaque
            document.querySelector('.sort-dropdown').value = 'destaque';
            sortProducts('destaque');
            break;
    }
    
    filterProducts();
}

// Limpar todos os filtros
function clearAllFilters() {
    // Limpar checkboxes de categoria
    document.querySelectorAll('.filter-option input[type="checkbox"]').forEach(cb => {
        cb.checked = cb.value === '';
    });
    
    // Limpar checkboxes de tamanho
    document.querySelectorAll('.size-option input[type="checkbox"]').forEach(cb => {
        cb.checked = cb.value === '';
    });
    
    // Limpar pre√ßos
    document.getElementById('min-price').value = '';
    document.getElementById('max-price').value = '';
    
    // Limpar filtros r√°pidos
    document.querySelectorAll('.quick-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Resetar ordena√ß√£o
    document.querySelector('.sort-dropdown').value = 'destaque';
    
    filterProducts();
}

// Fun√ß√£o melhorada para adicionar ao carrinho com anima√ß√£o
function addToCart(produtoId, produtoNome) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Adicionar classe de loading
    button.classList.add('loading');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando...';
    button.disabled = true;
    
    // Efeito visual no card
    const card = button.closest('.product-card');
    card.style.transform = 'scale(0.98)';
    
    // Simular requisi√ß√£o
    setTimeout(() => {
        // Restaurar card
        card.style.transform = '';
        
        // Redirecionar
        window.location.href = `/carrinho/adicionar/${produtoId}`;
    }, 800);
}

// Fun√ß√£o melhorada para visualiza√ß√£o r√°pida
function quickView(produtoId) {
    const button = event.target.closest('.quick-view-btn');
    const originalText = button.innerHTML;
    
    // Loading state
    button.classList.add('loading');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Carregando...</span>';
    
    // Mostrar loading overlay
    showLoadingOverlay();
    
    currentProductId = produtoId;
    const produto = productData[produtoId];
    
    if (!produto) {
        console.error('Produto n√£o encontrado:', produtoId);
        hideLoadingOverlay();
        button.classList.remove('loading');
        button.innerHTML = originalText;
        return;
    }
    
    // Simular carregamento
    setTimeout(() => {
        // Preencher dados no modal
        const modalImg = document.getElementById('modal-product-image');
        const imgSrc = produto.imagem || 'https://via.placeholder.com/500x500/f8f9fa/6c757d?text=Imagem+Indispon%C3%ADvel';
        
        modalImg.style.opacity = '0.5';
        modalImg.src = imgSrc;
        
        modalImg.onload = function() {
            this.style.opacity = '1';
        };
        
        modalImg.onerror = function() {
            this.src = 'https://via.placeholder.com/500x500/f8f9fa/6c757d?text=Imagem+Indispon%C3%ADvel';
            this.style.opacity = '1';
        };
        
        modalImg.alt = produto.nome;
        document.getElementById('modal-product-category').textContent = produto.categoria;
        document.getElementById('modal-product-name').textContent = produto.nome;
        document.getElementById('modal-product-price').textContent = formatCurrency(produto.preco);
        document.getElementById('modal-product-description').textContent = produto.descricao;
        
        // Resetar tamanho selecionado
        selectedSize = 'M';
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const mBtn = document.querySelector('.size-btn[onclick="selectSize(\'M\')"]');
        if (mBtn) mBtn.classList.add('active');
        
        // Esconder loading overlay
        hideLoadingOverlay();
        
        // Mostrar modal
        const modal = document.getElementById('quick-view-modal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);
        
        // Bloquear scroll do body
        document.body.style.overflow = 'hidden';
        
        // Restaurar bot√£o
        button.classList.remove('loading');
        button.innerHTML = originalText;
    }, 600);
}

// Adicionar aos favoritos
function addToWishlist(produtoId) {
    const button = event.target;
    const originalColor = button.style.color;
    
    // Anima√ß√£o de cora√ß√£o
    button.style.color = '#ff4757';
    button.style.transform = 'scale(1.3)';
    
    setTimeout(() => {
        button.style.transform = 'scale(1)';
    }, 200);
    
    // Feedback visual
    showToast('‚ù§Ô∏è Produto adicionado aos favoritos!', 'success');
}

// Fun√ß√µes de loading overlay
function showLoadingOverlay() {
    let overlay = document.querySelector('.loading-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.innerHTML = '<div class="loading-spinner"></div>';
        document.body.appendChild(overlay);
    }
    overlay.style.display = 'flex';
}

function hideLoadingOverlay() {
    const overlay = document.querySelector('.loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#2ecc71' : '#3498db'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Adicionar anima√ß√µes CSS para toast
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Dados dos produtos para o modal
const productData = {
{% for produto in produtos %}
{{ produto.id }}: {
    id: {{ produto.id }},
    nome: "{{ produto.nome }}",
    preco: {{ produto.preco }},
    categoria: "{{ produto.categoria or 'Produto' }}",
    imagem: "{{ produto.imagem or '' }}",
    descricao: "{{ produto.descricao or 'Produto de alta qualidade com excelente acabamento e conforto.' }}"
}{% if not loop.last %},{% endif %}
{% endfor %}
};

let currentProductId = null;
let selectedSize = 'M';

// Abrir visualiza√ß√£o r√°pida
function quickView(produtoId) {
    currentProductId = produtoId;
    const produto = productData[produtoId];
    
    if (!produto) {
        console.error('Produto n√£o encontrado:', produtoId);
        return;
    }
    
    // Preencher dados no modal
    const modalImg = document.getElementById('modal-product-image');
    const imgSrc = produto.imagem || 'https://via.placeholder.com/500x500/f8f9fa/6c757d?text=Imagem+Indispon%C3%ADvel';
    
    // Mostrar loading enquanto carrega
    modalImg.style.opacity = '0.5';
    modalImg.src = imgSrc;
    
    modalImg.onload = function() {
        this.style.opacity = '1';
    };
    
    modalImg.onerror = function() {
        this.src = 'https://via.placeholder.com/500x500/f8f9fa/6c757d?text=Imagem+Indispon%C3%ADvel';
        this.style.opacity = '1';
    };
    
    modalImg.alt = produto.nome;
    document.getElementById('modal-product-category').textContent = produto.categoria;
    document.getElementById('modal-product-name').textContent = produto.nome;
    document.getElementById('modal-product-price').textContent = formatCurrency(produto.preco);
    document.getElementById('modal-product-description').textContent = produto.descricao;
    
    // Resetar tamanho selecionado
    selectedSize = 'M';
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const mBtn = document.querySelector('.size-btn[onclick="selectSize(\'M\')"]');
    if (mBtn) mBtn.classList.add('active');
    
    // Mostrar modal
    const modal = document.getElementById('quick-view-modal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('active');
    }, 10);
    
    // Bloquear scroll do body
    document.body.style.overflow = 'hidden';
}

// Fechar modal
function closeQuickView() {
    const modal = document.getElementById('quick-view-modal');
    modal.classList.remove('active');
    
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }, 300);
}

// Selecionar tamanho
function selectSize(size) {
    selectedSize = size;
    
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
}

// Adicionar ao carrinho do modal
function addToCartFromModal() {
    if (!currentProductId) return;
    
    const button = document.getElementById('modal-add-cart');
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando...';
    button.disabled = true;
    
    // Simular requisi√ß√£o
    setTimeout(() => {
        window.location.href = `/carrinho/adicionar/${currentProductId}`;
    }, 500);
}

// Adicionar √† lista de desejos
function addToWishlist() {
    if (!currentProductId) return;
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-heart" style="color: #ff4757;"></i> Favoritado!';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

// Formatar moeda
function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeQuickView();
    }
});

// Melhorar carregamento das imagens
document.addEventListener('DOMContentLoaded', function() {
    // Lazy loading para imagens
    const images = document.querySelectorAll('.product-image img');
    
    images.forEach(img => {
        // Quando a imagem carregar com sucesso
        img.addEventListener('load', function() {
            this.classList.add('loaded');
        });
        
        // Se a imagem falhar ao carregar
        img.addEventListener('error', function() {
            console.log('Erro ao carregar imagem:', this.src);
            
            // Criar placeholder personalizado
            const placeholder = document.createElement('div');
            placeholder.className = 'product-placeholder';
            placeholder.innerHTML = `
                <i class="fas fa-image"></i>
                <p>Imagem indispon√≠vel</p>
            `;
            
            // Substituir a imagem pelo placeholder
            this.parentNode.insertBefore(placeholder, this);
            this.style.display = 'none';
        });
        
        // For√ßar verifica√ß√£o se a imagem j√° est√° carregada
        if (img.complete) {
            img.classList.add('loaded');
        }
    });
});

// Atualizar fun√ß√£o quickView para lidar melhor com imagens
function quickView(produtoId) {
    const button = event.target.closest('.quick-view-btn');
    const originalText = button.innerHTML;
    
    // Loading state
    button.classList.add('loading');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Carregando...</span>';
    
    // Mostrar loading overlay
    showLoadingOverlay();
    
    currentProductId = produtoId;
    const produto = productData[produtoId];
    
    if (!produto) {
        console.error('Produto n√£o encontrado:', produtoId);
        hideLoadingOverlay();
        button.classList.remove('loading');
        button.innerHTML = originalText;
        return;
    }
    
    // Simular carregamento
    setTimeout(() => {
        // Preencher dados no modal
        const modalImg = document.getElementById('modal-product-image');
        const imgSrc = produto.imagem || 'https://via.placeholder.com/500x500/f8f9fa/6c757d?text=Imagem+Indispon%C3%ADvel';
        
        modalImg.style.opacity = '0.5';
        modalImg.src = imgSrc;
        
        modalImg.onload = function() {
            this.style.opacity = '1';
        };
        
        modalImg.onerror = function() {
            this.src = 'https://via.placeholder.com/500x500/f8f9fa/6c757d?text=Imagem+Indispon%C3%ADvel';
            this.style.opacity = '1';
        };
        
        modalImg.alt = produto.nome;
        document.getElementById('modal-product-category').textContent = produto.categoria;
        document.getElementById('modal-product-name').textContent = produto.nome;
        document.getElementById('modal-product-price').textContent = formatCurrency(produto.preco);
        document.getElementById('modal-product-description').textContent = produto.descricao;
        
        // Resetar tamanho selecionado
        selectedSize = 'M';
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const mBtn = document.querySelector('.size-btn[onclick="selectSize(\'M\')"]');
        if (mBtn) mBtn.classList.add('active');
        
        // Esconder loading overlay
        hideLoadingOverlay();
        
        // Mostrar modal
        const modal = document.getElementById('quick-view-modal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);
        
        // Bloquear scroll do body
        document.body.style.overflow = 'hidden';
        
        // Restaurar bot√£o
        button.classList.remove('loading');
        button.innerHTML = originalText;
    }, 600);
}
</script>
{% endblock %}
