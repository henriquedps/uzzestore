{% extends "base.html" %}

{% block title %}{{ produto.nome }} - UzzerStore{% endblock %}

{% block head %}
<style>
    .produto-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #fff;
    }

    .produto-main {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-bottom: 40px;
    }

    .produto-galeria {
        position: relative;
        min-height: 360px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fafafa;
        border-radius: 12px;
        overflow: hidden;
    }

    .imagem-principal {
        width: 100%;
        height: 600px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .imagem-principal:hover {
        transform: scale(1.02);
    }

    .produto-info {
        padding: 20px;
    }

    .produto-categoria {
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
    }

    .produto-nome {
        font-size: 2.5rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 15px;
        line-height: 1.2;
    }

    .produto-preco {
        font-size: 2rem;
        font-weight: 600;
        color: #e91e63;
        margin-bottom: 20px;
    }

    .produto-descricao {
        font-size: 16px;
        line-height: 1.6;
        color: #666;
        margin-bottom: 30px;
    }

    .tamanhos-section {
        margin-bottom: 30px;
    }

    .tamanhos-label {
        font-weight: 600;
        margin-bottom: 15px;
        display: block;
        color: #333;
    }

    .tamanhos-opcoes {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        
    }

    .tamanho-opcao {
        padding: 12px 20px;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        background: #fff;
    }

    .tamanho-opcao:hover {
        border-color: #e91e63;
        background: #fce4ec;
    }

    .tamanho-opcao.selecionado {
        border-color: #e91e63;
        background: #e91e63;
        color: white;
    }

    .compra-controles {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 30px;
    }

    .quantidade-input {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        width: 80px;
        text-align: center;
        font-weight: 500;
    }

    .btn-adicionar-carrinho {
        flex: 1;
        padding: 15px 30px;
        background: linear-gradient(135deg, #e91e63, #ad1457);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-adicionar-carrinho:hover {
        background: linear-gradient(135deg, #ad1457, #880e4f);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(233, 30, 99, 0.3);
    }

    .produtos-relacionados {
        margin-top: 60px;
    }

    .relacionados-titulo {
        font-size: 2rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 40px;
        color: #333;
    }

    .relacionados-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
    }

    .produto-relacionado {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .produto-relacionado:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }

    .produto-relacionado img {
        width: 100%;
        height: 300px;
        object-fit: cover;
    }

    .produto-relacionado-info {
        padding: 20px;
    }

    .produto-relacionado-nome {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
    }

    .produto-relacionado-preco {
        font-size: 1.2rem;
        font-weight: 600;
        color: #e91e63;
    }

    @media (max-width: 768px) {
        .produto-main {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .produto-nome {
            font-size: 2rem;
        }

        .produto-preco {
            font-size: 1.5rem;
        }

        .compra-controles {
            flex-direction: column;
        }

        .btn-adicionar-carrinho {
            width: 100%;
        }

        .relacionados-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }

    .notification.success {
        background: #4caf50;
    }

    .notification.show {
        transform: translateX(0);
    }
</style>
{% endblock %}

{% block content %}
<div class="produto-container">
    <div class="produto-main">
        <div class="produto-galeria">
            {% set placeholder = "data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"800\" height=\"600\"><rect width=\"100%\" height=\"100%\" fill=\"%23f3f4f6\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%23999\" font-family=\"Arial, Helvetica, sans-serif\" font-size=\"28\">Sem imagem</text></svg>" %}
            {% if produto.imagem %}
                {% if produto.imagem.startswith('http') or produto.imagem.startswith('/') %}
                    <img src="{{ produto.imagem }}" alt="{{ produto.nome }}" class="imagem-principal" id="imagemPrincipal" onerror="this.onerror=null; this.src='{{ placeholder }}';">
                {% else %}
                    <img src="{{ url_for('static', filename=produto.imagem) }}" alt="{{ produto.nome }}" class="imagem-principal" id="imagemPrincipal" onerror="this.onerror=null; this.src='{{ placeholder }}';">
                {% endif %}
            {% else %}
                <img src="{{ placeholder }}" alt="{{ produto.nome }}" class="imagem-principal" id="imagemPrincipal">
            {% endif %}
        </div>

        <div class="produto-info">
            <div class="produto-categoria">{{ produto.categoria }}</div>
            <h1 class="produto-nome">{{ produto.nome }}</h1>
            <div class="produto-preco">R$ {{ "%.2f"|format(produto.preco) }}</div>
            <p class="produto-descricao">{{ produto.descricao }}</p>

            {% if produto.tamanhos %}
            <div class="tamanhos-section">
                <label class="tamanhos-label">Tamanho:</label>
                <div class="tamanhos-opcoes">
                    {% for tamanho in produto.tamanhos.split(',') %}
                    <div class="tamanho-opcao{% if loop.first %} selecionado{% endif %}" 
                         data-tamanho="{{ tamanho.strip() }}" 
                         onclick="selecionarTamanho(this)">
                        {{ tamanho.strip() }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="compra-controles">
                <input type="number" value="1" min="1" max="99" class="quantidade-input" id="quantidade">
                <button class="btn-adicionar-carrinho" onclick="adicionarAoCarrinho()">
                    Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>

    {% if produtos_relacionados %}
    <div class="produtos-relacionados">
        <h2 class="relacionados-titulo">Produtos Relacionados</h2>
        <div class="relacionados-grid">
            {% for produto_rel in produtos_relacionados %}
                <div class="produto-relacionado" onclick="irParaProduto({{ produto_rel.id }})">
                {% if produto_rel.imagem %}
                    {% if produto_rel.imagem.startswith('http') or produto_rel.imagem.startswith('/') %}
                        <img src="{{ produto_rel.imagem }}" alt="{{ produto_rel.nome }}" onerror="this.onerror=null; this.src='{{ placeholder }}';">
                    {% else %}
                        <img src="{{ url_for('static', filename=produto_rel.imagem) }}" alt="{{ produto_rel.nome }}" onerror="this.onerror=null; this.src='{{ placeholder }}';">
                    {% endif %}
                {% else %}
                    <img src="{{ placeholder }}" alt="{{ produto_rel.nome }}">
                {% endif %}
                <div class="produto-relacionado-info">
                    <div class="produto-relacionado-nome">{{ produto_rel.nome }}</div>
                    <div class="produto-relacionado-preco">R$ {{ "%.2f"|format(produto_rel.preco) }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
let tamanhoSelecionado = '';
let corAtual = 'Padrão';

function selecionarTamanho(elemento) {
    document.querySelectorAll('.tamanho-opcao').forEach(el => {
        el.classList.remove('selecionado');
    });
    
    elemento.classList.add('selecionado');
    tamanhoSelecionado = elemento.dataset.tamanho;
}

async function adicionarAoCarrinho() {
    const quantidade = document.getElementById('quantidade').value;
    
    const temTamanhos = document.querySelectorAll('.tamanho-opcao').length > 0;
    if (temTamanhos && !tamanhoSelecionado) {
        showNotification('Por favor, selecione um tamanho', 'error');
        return;
    }

    const corSelecionada = corAtual || 'Padrão';
    const produtoId = {{ produto.id }};

    try {
        // Fazer requisição para adicionar ao carrinho no servidor
        const url = `/carrinho/adicionar/${produtoId}?ajax=true&q=${quantidade}&tamanho=${encodeURIComponent(tamanhoSelecionado || 'M')}&cor=${encodeURIComponent(corSelecionada)}`;
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message || 'Produto adicionado ao carrinho!', 'success');
            
            // Atualizar contador do carrinho
            updateCartCount();
            
            // Abrir sacola lateral se existir
            if (typeof toggleSacola === 'function') {
                setTimeout(() => toggleSacola(), 500);
            }
        } else {
            showNotification(data.message || 'Erro ao adicionar produto', 'error');
        }
    } catch (error) {
        console.error('Erro ao adicionar ao carrinho:', error);
        showNotification('Erro ao adicionar produto ao carrinho', 'error');
    }
}

function irParaProduto(produtoId) {
    window.location.href = `/produto/${produtoId}`;
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

async function updateCartCount() {
    try {
        const response = await fetch('/api/carrinho');
        const data = await response.json();
        
        const totalItens = data.items ? data.items.reduce((total, item) => total + item.quantidade, 0) : 0;
        
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            cartCount.textContent = totalItens;
            cartCount.style.display = totalItens > 0 ? 'block' : 'none';
        }
    } catch (error) {
        console.error('Erro ao atualizar contador do carrinho:', error);
    }
}

document.getElementById('quantidade').addEventListener('input', function(e) {
    let value = parseInt(e.target.value);
    if (isNaN(value) || value < 1) {
        e.target.value = 1;
    } else if (value > 99) {
        e.target.value = 99;
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const primeiroTamanho = document.querySelector('.tamanho-opcao.selecionado');
    if (primeiroTamanho) {
        tamanhoSelecionado = primeiroTamanho.dataset.tamanho;
    }
    
    updateCartCount();
});
</script>
{% endblock %}